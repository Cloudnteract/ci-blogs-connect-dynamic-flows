AWSTemplateFormatVersion: "2010-09-09"

Description: Amazon Connect Flow Data

Transform: AWS::Serverless-2016-10-31

Parameters:
  pConnectInstanceArn:
    Type: String
  pLogLevel:
    Description: Dev=DEBUG, Prod=INFO
    Type: String
    Default: INFO
    AllowedValues:
      - CRITICAL
      - ERROR
      - WARNING
      - INFO
      - DEBUG

Globals:
  Function:
    Runtime: python3.11
    MemorySize: 128
    Environment:
      Variables:
        LOG_LEVEL: !Ref pLogLevel


Resources:
####
# DynamoDb Table - Contact Flow Data
####
  rDynamoDbTableConnectFlowData:
    Type: AWS::DynamoDB::Table
    Properties:
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: Primary_Key
          AttributeType: S
        - AttributeName: Resource_Type
          AttributeType: S
      KeySchema:
        - AttributeName: Primary_Key
          KeyType: "HASH"
        - AttributeName: Resource_Type
          KeyType: "RANGE"


####
# Amazon Connect Get Flow Config Lambda
####
  rIAMRoleConnectGetFlowData:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - lambda.amazonaws.com
            Action:
              - sts:AssumeRole
      Path: /
      Policies:
        - PolicyName: dynamodb-access
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              Action:
                - dynamodb:GetItem
              Effect: Allow
              Resource: !GetAtt rDynamoDbTableConnectFlowData.Arn
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole

  rLambdaConnectGetFlowData:
    Type: AWS::Serverless::Function
    Properties:
      Timeout: 3
      Handler: index.lambda_handler
      Environment:
        Variables:
          DDB_TABLENAME: !Ref rDynamoDbTableConnectFlowData
      InlineCode: |
        import logging
        import os
        import boto3
        from datetime import datetime
        from dateutil import tz

        LOG_LEVEL = os.environ.get("LOG_LEVEL", logging.INFO)
        DDB_TABLENAME = os.environ.get("DDB_TABLENAME", "NOTFOUND")

        root_logger = logging.getLogger()
        root_logger.setLevel(logging.WARN)
        log = logging.getLogger(__name__)
        log.setLevel(LOG_LEVEL)
        log.info(f"Lambda Initiated, LOG_LEVEL = {LOG_LEVEL}, DDB_TABLENAME = {DDB_TABLENAME}")

        resource_ddb = boto3.resource('dynamodb')
        ddb_table = resource_ddb.Table(DDB_TABLENAME)
        log.debug(f"DynamoDb Resource Created for table: {DDB_TABLENAME}")

        def get_ddb_item(primary_key, resource_type):
            log.debug(f"Fetching DynamoDb Item using Primary Key: {primary_key}, Resource Type: {resource_type}")
            response_ddb = ddb_table.get_item(
                Key={
                    'Primary_Key': primary_key,
                    'Resource_Type': resource_type
                    }
                )
            log.debug(f"DynamoDb GetItem Response: {response_ddb}")

            if 'Item' in response_ddb:
                log.debug(f"Item Found: {response_ddb['Item']}")
                response = response_ddb['Item']
            else:
                log.error(f"No Item Found for Primary Key: {primary_key}, Resource Type: {resource_type}")
                response = None
            return response



        def lambda_handler(event, context):
            log.debug(f"Event: {event}")
            log.debug(f"Context: {context}")
            primary_key = event.get("Details", {}).get("Parameters", {}).get("Primary_Key")
            resource_type = event.get("Details", {}).get("Parameters", {}).get("Resource_Type")
            
            if primary_key is not None and resource_type is not None:
                log.info(f"Fetching Config for Primary_Key: {primary_key}, Resource_Type: {resource_type}")
                response = get_ddb_item(primary_key, resource_type)
            else:
                # At least one of 'Primary_Key' or 'Resource_Type' is missing or has a None value
                log.error("One or both of 'Primary_Key' and 'Resource_Type' are missing or have a None value.")
                response = None


            log.info(f"Returning: {response}")
            return response

      Role: !GetAtt rIAMRoleConnectGetFlowData.Arn

  rLogGroupLambdaConnectGetFlowData:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub "/aws/lambda/${rLambdaConnectGetFlowData}"
      RetentionInDays: 60 

  rConnectIntegrationAssociationLambdaConnectGetFlowData:
    Type: AWS::Connect::IntegrationAssociation
    Properties:
      InstanceId: !Ref pConnectInstanceArn
      IntegrationType: LAMBDA_FUNCTION
      IntegrationArn: !GetAtt rLambdaConnectGetFlowData.Arn

  rLambdaPermissionConnectGetFlowData:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Ref rLambdaConnectGetFlowData
      Principal: connect.amazonaws.com
      SourceArn: !Ref pConnectInstanceArn

####
# Connect Resources - Contact Flow Modules
####
  rConnectContactFlowModuleCloudInteractCorePlayPrompt:
    Type: AWS::Connect::ContactFlowModule
    Properties:
      Description: Core Play Prompt
      Name: CloudInteract_Core_PlayPrompt
      State: ACTIVE
      InstanceArn: !Ref pConnectInstanceArn
      Content: |
        {"Version": "2019-10-30", "StartAction": "2f01cab5-0b3e-43d6-acea-1138d05df4cf", "Metadata": {"entryPointPosition": {"x": 40, "y": 40}, "ActionMetadata": {"2f01cab5-0b3e-43d6-acea-1138d05df4cf": {"position": {"x": 205.6, "y": 180.8}, "conditions": [], "conditionMetadata": [{"id": "ba63445f-5764-4227-9632-b05566c4fd7a", "operator": {"name": "Equals", "value": "Equals", "shortDisplay": "="}, "value": "$.Attributes.Null"}, {"id": "d787462b-2a41-4235-abec-8f570698f386", "operator": {"name": "Starts with", "value": "StartsWith", "shortDisplay": "starts with"}, "value": "arn"}, {"id": "fd406b32-c53b-46b7-8f85-252d84c75aaa", "operator": {"name": "Starts with", "value": "StartsWith", "shortDisplay": "starts with"}, "value": "http"}, {"id": "bd7ebd81-9a95-4b32-a4fb-8b28caaffc2a", "operator": {"name": "Starts with", "value": "StartsWith", "shortDisplay": "starts with"}, "value": "<speak>"}]}, "2b5f8a0e-e235-4ecc-a120-a521ff1f5e28": {"position": {"x": 892, "y": 1044.8}}, "43e1d8c0-0ec2-477c-97cd-ecc6e12bcaae": {"position": {"x": 472.8, "y": -5.6}}, "cb3d0d5e-223f-49d6-acf9-46d2b1541c9f": {"position": {"x": 497.6, "y": 196}, "parameters": {"PromptId": {"useDynamic": true}}, "useDynamic": true}, "689ad25f-4604-498c-9f13-45a2a71f3b6f": {"position": {"x": 503.2, "y": 422.4}, "parameters": {"Media": {"Uri": {"useDynamic": true}}}, "useDynamic": true}, "5f366c37-7e81-46fb-a0bd-5592501019bf": {"position": {"x": 474.4, "y": 632}, "parameters": {"SSML": {"useDynamic": true}}, "useDynamic": true}, "37ae667d-cf4d-47a1-b759-0a1951705e40": {"position": {"x": 1229.6, "y": 473.6}}, "af0819c4-b850-4744-a16d-27af380663a2": {"position": {"x": 444.8, "y": 840}, "parameters": {"Text": {"useDynamic": true}}, "useDynamic": true}, "ac11e43b-343e-4a67-84ec-603a509059db": {"position": {"x": 976, "y": -22.4}, "parameters": {"Attributes": {"Prompt_Flow_TempModuleAttribute": {"useDynamic": true}}}, "dynamicParams": ["Prompt_Flow_TempModuleAttribute"]}}, "Annotations": []}, "Actions": [{"Parameters": {"ComparisonValue": "$.Attributes.Prompt_Flow_TempModuleAttribute"}, "Identifier": "2f01cab5-0b3e-43d6-acea-1138d05df4cf", "Type": "Compare", "Transitions": {"NextAction": "af0819c4-b850-4744-a16d-27af380663a2", "Conditions": [{"NextAction": "43e1d8c0-0ec2-477c-97cd-ecc6e12bcaae", "Condition": {"Operator": "Equals", "Operands": ["$.Attributes.Null"]}}, {"NextAction": "cb3d0d5e-223f-49d6-acf9-46d2b1541c9f", "Condition": {"Operator": "TextStartsWith", "Operands": ["arn"]}}, {"NextAction": "689ad25f-4604-498c-9f13-45a2a71f3b6f", "Condition": {"Operator": "TextStartsWith", "Operands": ["http"]}}, {"NextAction": "5f366c37-7e81-46fb-a0bd-5592501019bf", "Condition": {"Operator": "TextStartsWith", "Operands": ["<speak>"]}}], "Errors": [{"NextAction": "af0819c4-b850-4744-a16d-27af380663a2", "ErrorType": "NoMatchingCondition"}]}}, {"Parameters": {"FlowAttributes": {"Log_ERROR": {"Value": "Unable to play Prompt_Flow_TempModuleAttribute: $.Attributes.Prompt_Flow_TempModuleAttribute , returning to flow"}}}, "Identifier": "2b5f8a0e-e235-4ecc-a120-a521ff1f5e28", "Type": "UpdateFlowAttributes", "Transitions": {"NextAction": "37ae667d-cf4d-47a1-b759-0a1951705e40", "Errors": [{"NextAction": "37ae667d-cf4d-47a1-b759-0a1951705e40", "ErrorType": "NoMatchingError"}]}}, {"Parameters": {"FlowAttributes": {"Log_WARN": {"Value": "Prompt_Flow_TempModuleAttribute was empty, returning to flow"}}}, "Identifier": "43e1d8c0-0ec2-477c-97cd-ecc6e12bcaae", "Type": "UpdateFlowAttributes", "Transitions": {"NextAction": "ac11e43b-343e-4a67-84ec-603a509059db", "Errors": [{"NextAction": "ac11e43b-343e-4a67-84ec-603a509059db", "ErrorType": "NoMatchingError"}]}}, {"Parameters": {"PromptId": "$.Attributes.Prompt_Flow_TempModuleAttribute"}, "Identifier": "cb3d0d5e-223f-49d6-acf9-46d2b1541c9f", "Type": "MessageParticipant", "Transitions": {"NextAction": "ac11e43b-343e-4a67-84ec-603a509059db", "Errors": [{"NextAction": "2b5f8a0e-e235-4ecc-a120-a521ff1f5e28", "ErrorType": "NoMatchingError"}]}}, {"Parameters": {"Media": {"Uri": "$.Attributes.Prompt_Flow_TempModuleAttribute", "SourceType": "S3", "MediaType": "Audio"}}, "Identifier": "689ad25f-4604-498c-9f13-45a2a71f3b6f", "Type": "MessageParticipant", "Transitions": {"NextAction": "ac11e43b-343e-4a67-84ec-603a509059db", "Errors": [{"NextAction": "2b5f8a0e-e235-4ecc-a120-a521ff1f5e28", "ErrorType": "NoMatchingError"}]}}, {"Parameters": {"SSML": "$.Attributes.Prompt_Flow_TempModuleAttribute"}, "Identifier": "5f366c37-7e81-46fb-a0bd-5592501019bf", "Type": "MessageParticipant", "Transitions": {"NextAction": "ac11e43b-343e-4a67-84ec-603a509059db", "Errors": [{"NextAction": "2b5f8a0e-e235-4ecc-a120-a521ff1f5e28", "ErrorType": "NoMatchingError"}]}}, {"Parameters": {}, "Identifier": "37ae667d-cf4d-47a1-b759-0a1951705e40", "Type": "EndFlowModuleExecution", "Transitions": {}}, {"Parameters": {"Text": "$.Attributes.Prompt_Flow_TempModuleAttribute"}, "Identifier": "af0819c4-b850-4744-a16d-27af380663a2", "Type": "MessageParticipant", "Transitions": {"NextAction": "ac11e43b-343e-4a67-84ec-603a509059db", "Errors": [{"NextAction": "2b5f8a0e-e235-4ecc-a120-a521ff1f5e28", "ErrorType": "NoMatchingError"}]}}, {"Parameters": {"Attributes": {"Prompt_Flow_TempModuleAttribute": "$.Attributes.Null"}, "TargetContact": "Current"}, "Identifier": "ac11e43b-343e-4a67-84ec-603a509059db", "Type": "UpdateContactAttributes", "Transitions": {"NextAction": "37ae667d-cf4d-47a1-b759-0a1951705e40", "Errors": [{"NextAction": "37ae667d-cf4d-47a1-b759-0a1951705e40", "ErrorType": "NoMatchingError"}]}}], "Settings": {"InputParameters": [], "OutputParameters": [], "Transitions": []}}

  rConnectContactFlowModuleCloudInteractCoreRecordingAnalyticsBehavior:
    Type: AWS::Connect::ContactFlowModule
    Properties:
      Description: Set Recording and Analytics Settings
      Name: CloudInteract_Core_RecordingAnalyticsBehavior
      State: ACTIVE
      InstanceArn: !Ref pConnectInstanceArn
      Content: |
        {"Version": "2019-10-30", "StartAction": "Determine Contact Recording", "Metadata": {"entryPointPosition": {"x": -65.6, "y": -266.4}, "ActionMetadata": {"4c52f1dc-06b3-4c45-864b-b4b3d523556f": {"position": {"x": 576.8, "y": -293.6}}, "b8136bac-fd13-4e22-9b41-d4d7eb3b0595": {"position": {"x": 327.2, "y": -301.6}}, "Determine Contact Recording": {"position": {"x": 73.6, "y": -304}, "isFriendlyName": true, "conditions": [], "conditionMetadata": [{"id": "2ed6bcb3-5fb4-4335-b791-d93690387433", "operator": {"name": "Equals", "value": "Equals", "shortDisplay": "="}, "value": "disabled"}, {"id": "425e5761-292b-4539-a92f-88a5c38c941c", "operator": {"name": "Equals", "value": "Equals", "shortDisplay": "="}, "value": "enabled"}]}, "3a6c7d13-a5e0-4b32-bd43-534e7a27a461": {"position": {"x": 616.8, "y": 1266.4}}, "Check Redaction Type": {"position": {"x": 33.6, "y": 95.2}, "isFriendlyName": true, "conditions": [], "conditionMetadata": [{"id": "6775e4d8-742e-45a7-b3b8-6e65d587c990", "operator": {"name": "Equals", "value": "Equals", "shortDisplay": "="}, "value": "RedactedAndOriginal"}, {"id": "1a98ec70-c4cf-4142-bcf7-0f54a5fc975a", "operator": {"name": "Equals", "value": "Equals", "shortDisplay": "="}, "value": "Redacted"}]}, "Determine Screen Recording": {"position": {"x": 24.8, "y": 408.8}, "isFriendlyName": true, "conditions": [], "conditionMetadata": [{"id": "18255327-da09-4c87-9f88-893e9b133ee3", "operator": {"name": "Equals", "value": "Equals", "shortDisplay": "="}, "value": "enabled"}, {"id": "1a81acea-34e6-4c3f-8a9a-956b25965b53", "operator": {"name": "Equals", "value": "Equals", "shortDisplay": "="}, "value": "disabled"}]}, "Set Default Redaction": {"position": {"x": 313.6, "y": 72}, "isFriendlyName": true, "dynamicParams": []}, "d573af1c-927d-45ca-ad42-e59e46098fc4": {"position": {"x": 598.4, "y": 862.4}, "parameters": {"AnalyticsBehavior": {"AnalyticsLanguage": {"useDynamic": true}, "AnalyticsRedactionResults": {"useDynamic": true}}}}, "26267062-7f4d-40d7-9e15-7cf52a16dab4": {"position": {"x": 948, "y": 1131.2}}, "Determine Analytics": {"position": {"x": 336.8, "y": 992}, "isFriendlyName": true, "conditions": [], "conditionMetadata": [{"id": "574ab56d-fe6c-4d5b-a9da-f4a02721b5e7", "operator": {"name": "Equals", "value": "Equals", "shortDisplay": "="}, "value": "postcall"}, {"id": "6d39aad7-00b4-4c58-af19-c0f0b8aa18b3", "operator": {"name": "Equals", "value": "Equals", "shortDisplay": "="}, "value": "realtime"}, {"id": "bd66dff9-e476-4ed5-8aaf-2c60a51279a5", "operator": {"name": "Equals", "value": "Equals", "shortDisplay": "="}, "value": "disabled"}]}, "6dec6277-bee8-45f1-8f75-3a7efdd66c58": {"position": {"x": 629.6, "y": 1024.8}, "parameters": {"AnalyticsBehavior": {"AnalyticsLanguage": {"useDynamic": true}, "AnalyticsRedactionResults": {"useDynamic": true}}}}, "e6b4415d-f681-4ba6-a5e2-13d0dd8aad30": {"position": {"x": 604.8, "y": 682.4}}, "1e8c7df8-ead9-47f0-b076-c7cf91e52939": {"position": {"x": 587.2, "y": 279.2}, "parameters": {"AnalyticsBehavior": {"AnalyticsLanguage": {"useDynamic": true}, "AnalyticsRedactionResults": {"useDynamic": true}}}}, "66220a79-f9f1-4e4c-8e7f-c9d0c1d46daa": {"position": {"x": 1624, "y": 593.6}}, "Determine Analytics with Screenrecording": {"position": {"x": 326.4, "y": 408.8}, "isFriendlyName": true, "conditions": [], "conditionMetadata": [{"id": "6aedac7b-2e94-4877-9c29-2d9a6f08ef97", "operator": {"name": "Equals", "value": "Equals", "shortDisplay": "="}, "value": "postcall"}, {"id": "3a42e494-ab01-44b0-a006-f7ac950d9ac3", "operator": {"name": "Equals", "value": "Equals", "shortDisplay": "="}, "value": "realtime"}, {"id": "df8a4092-7579-445e-886b-f7afb9714b36", "operator": {"name": "Equals", "value": "Equals", "shortDisplay": "="}, "value": "disabled"}]}, "ec8b7e2a-f656-4c19-aa9f-046e27c2ed66": {"position": {"x": 618.4, "y": 441.6}, "parameters": {"AnalyticsBehavior": {"AnalyticsLanguage": {"useDynamic": true}, "AnalyticsRedactionResults": {"useDynamic": true}}}}}, "Annotations": []}, "Actions": [{"Parameters": {}, "Identifier": "4c52f1dc-06b3-4c45-864b-b4b3d523556f", "Type": "EndFlowModuleExecution", "Transitions": {}}, {"Parameters": {"RecordingBehavior": {"RecordedParticipants": []}}, "Identifier": "b8136bac-fd13-4e22-9b41-d4d7eb3b0595", "Type": "UpdateContactRecordingBehavior", "Transitions": {"NextAction": "4c52f1dc-06b3-4c45-864b-b4b3d523556f"}}, {"Parameters": {"ComparisonValue": "$.Attributes.Flag_Queue_ContactRecording"}, "Identifier": "Determine Contact Recording", "Type": "Compare", "Transitions": {"NextAction": "Check Redaction Type", "Conditions": [{"NextAction": "b8136bac-fd13-4e22-9b41-d4d7eb3b0595", "Condition": {"Operator": "Equals", "Operands": ["disabled"]}}, {"NextAction": "Check Redaction Type", "Condition": {"Operator": "Equals", "Operands": ["enabled"]}}], "Errors": [{"NextAction": "Check Redaction Type", "ErrorType": "NoMatchingCondition"}]}}, {"Parameters": {"RecordingBehavior": {"RecordedParticipants": ["Agent", "Customer"], "ScreenRecordedParticipants": ["Agent"]}}, "Identifier": "3a6c7d13-a5e0-4b32-bd43-534e7a27a461", "Type": "UpdateContactRecordingBehavior", "Transitions": {"NextAction": "26267062-7f4d-40d7-9e15-7cf52a16dab4"}}, {"Parameters": {"ComparisonValue": "$.Attributes.Flag_Queue_Redaction"}, "Identifier": "Check Redaction Type", "Type": "Compare", "Transitions": {"NextAction": "Set Default Redaction", "Conditions": [{"NextAction": "Determine Screen Recording", "Condition": {"Operator": "Equals", "Operands": ["RedactedAndOriginal"]}}, {"NextAction": "Determine Screen Recording", "Condition": {"Operator": "Equals", "Operands": ["Redacted"]}}], "Errors": [{"NextAction": "Set Default Redaction", "ErrorType": "NoMatchingCondition"}]}}, {"Parameters": {"ComparisonValue": "$.Attributes.Flag_Queue_ScreenRecording"}, "Identifier": "Determine Screen Recording", "Type": "Compare", "Transitions": {"NextAction": "Determine Analytics", "Conditions": [{"NextAction": "Determine Analytics with Screenrecording", "Condition": {"Operator": "Equals", "Operands": ["enabled"]}}, {"NextAction": "Determine Analytics", "Condition": {"Operator": "Equals", "Operands": ["disabled"]}}], "Errors": [{"NextAction": "Determine Analytics", "ErrorType": "NoMatchingCondition"}]}}, {"Parameters": {"Attributes": {"Flag_Queue_Redaction": "RedactedAndOriginal"}, "TargetContact": "Current"}, "Identifier": "Set Default Redaction", "Type": "UpdateContactAttributes", "Transitions": {"NextAction": "Determine Screen Recording", "Errors": [{"NextAction": "Determine Screen Recording", "ErrorType": "NoMatchingError"}]}}, {"Parameters": {"RecordingBehavior": {"RecordedParticipants": ["Agent", "Customer"]}, "AnalyticsBehavior": {"Enabled": "True", "AnalyticsLanguage": "$.LanguageCode", "AnalyticsRedactionBehavior": "Enabled", "AnalyticsRedactionResults": "$.Attributes.Flag_Queue_Redaction", "AnalyticsRedactionMaskMode": "EntityType", "ChannelConfiguration": {"Chat": {"AnalyticsModes": ["ContactLens"]}, "Voice": {"AnalyticsModes": ["PostContact"]}}}}, "Identifier": "d573af1c-927d-45ca-ad42-e59e46098fc4", "Type": "UpdateContactRecordingBehavior", "Transitions": {"NextAction": "26267062-7f4d-40d7-9e15-7cf52a16dab4"}}, {"Parameters": {}, "Identifier": "26267062-7f4d-40d7-9e15-7cf52a16dab4", "Type": "EndFlowModuleExecution", "Transitions": {}}, {"Parameters": {"ComparisonValue": "$.Attributes.Flag_Queue_Analytics"}, "Identifier": "Determine Analytics", "Type": "Compare", "Transitions": {"NextAction": "3a6c7d13-a5e0-4b32-bd43-534e7a27a461", "Conditions": [{"NextAction": "d573af1c-927d-45ca-ad42-e59e46098fc4", "Condition": {"Operator": "Equals", "Operands": ["postcall"]}}, {"NextAction": "6dec6277-bee8-45f1-8f75-3a7efdd66c58", "Condition": {"Operator": "Equals", "Operands": ["realtime"]}}, {"NextAction": "3a6c7d13-a5e0-4b32-bd43-534e7a27a461", "Condition": {"Operator": "Equals", "Operands": ["disabled"]}}], "Errors": [{"NextAction": "3a6c7d13-a5e0-4b32-bd43-534e7a27a461", "ErrorType": "NoMatchingCondition"}]}}, {"Parameters": {"RecordingBehavior": {"RecordedParticipants": ["Agent", "Customer"]}, "AnalyticsBehavior": {"Enabled": "True", "AnalyticsLanguage": "$.LanguageCode", "AnalyticsRedactionBehavior": "Enabled", "AnalyticsRedactionResults": "$.Attributes.Flag_Queue_Redaction", "AnalyticsRedactionMaskMode": "EntityType", "ChannelConfiguration": {"Chat": {"AnalyticsModes": ["ContactLens"]}, "Voice": {"AnalyticsModes": ["RealTime"]}}}}, "Identifier": "6dec6277-bee8-45f1-8f75-3a7efdd66c58", "Type": "UpdateContactRecordingBehavior", "Transitions": {"NextAction": "26267062-7f4d-40d7-9e15-7cf52a16dab4"}}, {"Parameters": {"RecordingBehavior": {"RecordedParticipants": ["Agent", "Customer"], "ScreenRecordedParticipants": ["Agent"]}}, "Identifier": "e6b4415d-f681-4ba6-a5e2-13d0dd8aad30", "Type": "UpdateContactRecordingBehavior", "Transitions": {"NextAction": "66220a79-f9f1-4e4c-8e7f-c9d0c1d46daa"}}, {"Parameters": {"RecordingBehavior": {"RecordedParticipants": ["Agent", "Customer"], "ScreenRecordedParticipants": ["Agent"]}, "AnalyticsBehavior": {"Enabled": "True", "AnalyticsLanguage": "$.LanguageCode", "AnalyticsRedactionBehavior": "Enabled", "AnalyticsRedactionResults": "$.Attributes.Flag_Queue_Redaction", "AnalyticsRedactionMaskMode": "EntityType", "ChannelConfiguration": {"Chat": {"AnalyticsModes": ["ContactLens"]}, "Voice": {"AnalyticsModes": ["PostContact"]}}}}, "Identifier": "1e8c7df8-ead9-47f0-b076-c7cf91e52939", "Type": "UpdateContactRecordingBehavior", "Transitions": {"NextAction": "66220a79-f9f1-4e4c-8e7f-c9d0c1d46daa"}}, {"Parameters": {}, "Identifier": "66220a79-f9f1-4e4c-8e7f-c9d0c1d46daa", "Type": "EndFlowModuleExecution", "Transitions": {}}, {"Parameters": {"ComparisonValue": "$.Attributes.Flag_Queue_Analytics"}, "Identifier": "Determine Analytics with Screenrecording", "Type": "Compare", "Transitions": {"NextAction": "e6b4415d-f681-4ba6-a5e2-13d0dd8aad30", "Conditions": [{"NextAction": "1e8c7df8-ead9-47f0-b076-c7cf91e52939", "Condition": {"Operator": "Equals", "Operands": ["postcall"]}}, {"NextAction": "ec8b7e2a-f656-4c19-aa9f-046e27c2ed66", "Condition": {"Operator": "Equals", "Operands": ["realtime"]}}, {"NextAction": "e6b4415d-f681-4ba6-a5e2-13d0dd8aad30", "Condition": {"Operator": "Equals", "Operands": ["disabled"]}}], "Errors": [{"NextAction": "e6b4415d-f681-4ba6-a5e2-13d0dd8aad30", "ErrorType": "NoMatchingCondition"}]}}, {"Parameters": {"RecordingBehavior": {"RecordedParticipants": ["Agent", "Customer"], "ScreenRecordedParticipants": ["Agent"]}, "AnalyticsBehavior": {"Enabled": "True", "AnalyticsLanguage": "$.LanguageCode", "AnalyticsRedactionBehavior": "Enabled", "AnalyticsRedactionResults": "$.Attributes.Flag_Queue_Redaction", "AnalyticsRedactionMaskMode": "EntityType", "ChannelConfiguration": {"Chat": {"AnalyticsModes": ["ContactLens"]}, "Voice": {"AnalyticsModes": ["RealTime"]}}}}, "Identifier": "ec8b7e2a-f656-4c19-aa9f-046e27c2ed66", "Type": "UpdateContactRecordingBehavior", "Transitions": {"NextAction": "66220a79-f9f1-4e4c-8e7f-c9d0c1d46daa"}}], "Settings": {"InputParameters": [], "OutputParameters": [], "Transitions": []}}

####
# Connect Resources - Contact Flows
####
  rConnectContactFlowCloudInteractCoreInitiation:
    Type: AWS::Connect::ContactFlow
    Properties:
      Description: Initial Contact Flow all contacts are sent to
      Name: CloudInteract_Core_Initiation
      State: ACTIVE
      Type: CONTACT_FLOW
      InstanceArn: !Ref pConnectInstanceArn
      Content: !Sub
        - |
          {"Version": "2019-10-30", "StartAction": "b8346fd4-3e2d-497a-a4e6-af820e204381", "Metadata": {"entryPointPosition": {"x": 28, "y": -347.2}, "ActionMetadata": {"27016824-0532-4844-8922-29f1a8d0b2b6": {"position": {"x": 766.4, "y": 1764}, "parameters": {"ThirdPartyPhoneNumber": {"useDynamic": true}}}, "bc366dad-e400-4987-beca-ff2e949479b2": {"position": {"x": 770.4, "y": 1944.8}, "parameters": {"ThirdPartyPhoneNumber": {"useDynamic": true}, "CallerId": {"Number": {"inputOption": "dynamic"}}}, "callerIdSource": "dynamic"}, "b8346fd4-3e2d-497a-a4e6-af820e204381": {"position": {"x": 191.2, "y": -358.4}}, "0714d88a-f836-40c9-8762-38a6958e4b0c": {"position": {"x": 752.8, "y": 1380}}, "d150506c-ca09-47ee-b1fc-de86f38fdd00": {"position": {"x": 740.8, "y": 1192}, "parameters": {"ContactFlowId": {"displayName": "Voice_Core_SteeringMenu"}}, "ContactFlow": {"text": "Voice_Core_SteeringMenu"}}, "fb1c4dd7-7307-46e6-ad05-1756ebffb424": {"position": {"x": 992.8, "y": 1927.2}}, "76cdd1fb-6a98-402b-a3cb-b15a132b682d": {"position": {"x": 990.4, "y": 2372}}, "a9e57e87-a9d4-44f8-afde-0c688be8900c": {"position": {"x": 760.8, "y": 2236.8}, "parameters": {"QueueId": {"useDynamic": true}}, "useDynamic": true}, "0ea43059-94cb-4dbf-9397-32229a71933f": {"position": {"x": 1374.4, "y": 1711.2}, "parameters": {"ContactFlowId": {"displayName": "Voice_Core_PreQueue"}}, "ContactFlow": {"text": "Voice_Core_PreQueue"}}, "2642cd55-fd6c-407f-b8f6-b1235c7863bf": {"position": {"x": 1615.2, "y": 1723.2}}, "e2bfd1d3-4689-494d-9da6-67240f64456c": {"position": {"x": 492, "y": 1416}, "parameters": {"ContactFlowId": {"useDynamic": true}}, "useDynamic": true}, "4157dfe8-5e1f-4a5f-a767-7d76200c002f": {"position": {"x": 468, "y": 1221.6}, "parameters": {"Attributes": {"Flag_Flow_SteeringMenu": {"useDynamic": true}}}, "dynamicParams": ["Flag_Flow_SteeringMenu"]}, "b263f048-aedb-41a7-9302-487b1167b7f4": {"position": {"x": 513.6, "y": 1816}, "conditions": [], "conditionMetadata": [{"id": "10c191d9-c183-4133-afbe-4939ee0ae6b2", "operator": {"name": "Starts with", "value": "StartsWith", "shortDisplay": "starts with"}, "value": "+"}]}, "5439a893-5786-4f89-8399-3568dba83dde": {"position": {"x": 483.2, "y": 2522.4}}, "ee768dc5-695d-483a-907b-732bbc095ba2": {"position": {"x": 503.2, "y": 2090.4}, "conditions": [], "conditionMetadata": [{"id": "cde3c9e5-7859-4a35-bb79-e9a1c981ce9a", "operator": {"name": "Equals", "value": "Equals", "shortDisplay": "="}, "value": "$.Attributes.Null"}]}, "757492ea-6d47-4b22-b7a8-c67cd57034f5": {"position": {"x": 1140, "y": 1599.2}}, "6f17a6e7-cbca-43a1-a61a-e9543235020d": {"position": {"x": 536, "y": 1576}, "parameters": {"Attributes": {"Prompt_Flow_TempModuleAttribute": {"useDynamic": true}}}, "dynamicParams": ["Prompt_Flow_TempModuleAttribute"]}, "c67a1f1e-2287-474f-a000-3c67a2330aa4": {"position": {"x": 775.2, "y": 1573.6}, "parameters": {"FlowModuleId": {"displayName": "CloudInteract_Core_PlayPrompt"}}, "contactFlowModuleName": "CloudInteract_Core_PlayPrompt"}, "b2d9a2d3-1fd0-4c07-b495-ab13e0f0f053": {"position": {"x": 441.6, "y": 208.8}}, "579eadf9-c834-4bee-a4a4-679b49bb5efe": {"position": {"x": 432.8, "y": 571.2}, "parameters": {"Attributes": {"Prompt_Flow_TempModuleAttribute": {"useDynamic": true}}}, "dynamicParams": ["Prompt_Flow_TempModuleAttribute"]}, "9243e003-4096-431c-a771-d0bb069eb277": {"position": {"x": 188.8, "y": 560.8}, "conditions": [], "conditionMetadata": [{"id": "d9a45dd2-85bd-4a16-add6-6b54c53c5f24", "operator": {"name": "Equals", "value": "Equals", "shortDisplay": "="}, "value": "$.Attributes.Null"}]}, "a4852dbe-5b8a-4867-a8ae-f2315954d24c": {"position": {"x": 673.6, "y": 567.2}, "parameters": {"FlowModuleId": {"displayName": "CloudInteract_Core_PlayPrompt"}}, "contactFlowModuleName": "CloudInteract_Core_PlayPrompt"}, "da015edd-63db-4125-be54-9c7080eec344": {"position": {"x": 188.8, "y": 864.8}, "conditions": [], "conditionMetadata": [{"id": "b852f630-fcc3-4ca2-8813-897dc6ac3daf", "operator": {"name": "Equals", "value": "Equals", "shortDisplay": "="}, "value": "$.Attributes.Null"}]}, "99f173d2-8120-4dd7-ad2c-e433f89fb74b": {"position": {"x": 232, "y": 1439.2}, "conditions": [], "conditionMetadata": [{"id": "b169b7ba-e8a8-40e7-945e-49951c7b3ee7", "operator": {"name": "Equals", "value": "Equals", "shortDisplay": "="}, "value": "steeringmenu"}, {"id": "bb8d0560-952b-4b9b-a0fa-c5994825a5a5", "operator": {"name": "Equals", "value": "Equals", "shortDisplay": "="}, "value": "flow"}, {"id": "c1e1ea2a-4873-4e82-a10b-e977f7611c31", "operator": {"name": "Equals", "value": "Equals", "shortDisplay": "="}, "value": "disconnect"}, {"id": "f0f44bdf-fe59-4557-bdce-a353629acd47", "operator": {"name": "Equals", "value": "Equals", "shortDisplay": "="}, "value": "external"}, {"id": "dfca3de1-0880-4af7-902d-5a8b4c99e42c", "operator": {"name": "Equals", "value": "Equals", "shortDisplay": "="}, "value": "queue"}]}, "ffba1103-489c-4ea7-a1be-454b982d7b2b": {"position": {"x": 436.8, "y": 869.6}, "parameters": {"Attributes": {"Prompt_Flow_TempModuleAttribute": {"useDynamic": true}}}, "dynamicParams": ["Prompt_Flow_TempModuleAttribute"]}, "bc8f86e5-a736-4b4c-8d60-a40399dfbe2d": {"position": {"x": 677.6, "y": 865.6}, "parameters": {"FlowModuleId": {"displayName": "CloudInteract_Core_PlayPrompt"}}, "contactFlowModuleName": "CloudInteract_Core_PlayPrompt"}, "83b76e76-52cc-4732-81ff-1519b0c0f132": {"position": {"x": 1016.8, "y": -66.4}}, "2e9a94dc-3fd6-485e-a0c9-47d8cf2477fd": {"position": {"x": 734.4, "y": -91.2}}, "21cad021-fc67-4623-8c5d-0ed432aa6ef9": {"position": {"x": 449.6, "y": -364.8}, "children": ["81e9b39c-2025-400f-b533-280b13d715e0"], "overrideConsoleVoice": false, "fragments": {"SetContactData": "81e9b39c-2025-400f-b533-280b13d715e0"}, "overrideLanguageAttribute": true}, "81e9b39c-2025-400f-b533-280b13d715e0": {"position": {"x": 449.6, "y": -364.8}, "dynamicParams": []}, "3cdb26e7-57b8-4ccf-b4e8-11626a01466f": {"position": {"x": 191.2, "y": 208}, "parameters": {"QueueId": {"useDynamic": true}}, "useDynamic": true}, "c17aae39-eea0-40ab-a87b-757b43c4bf2a": {"position": {"x": 450.4, "y": -94.4}}, "1804d43f-0b41-4a08-b13f-71ecf7edb1b4": {"position": {"x": 194.4, "y": -90.4}, "parameters": {"LambdaFunctionARN": {"displayName": "${iLambdaLambdafunction}"}, "LambdaInvocationAttributes": {"Primary_Key": {"useDynamic": true}}}, "dynamicMetadata": {"Primary_Key": true, "Resource_Type": false}}}, "Annotations": []}, "Actions": [{"Parameters": {"ThirdPartyPhoneNumber": "$.External.Flag_DeliveryId_NextActionValue", "ThirdPartyConnectionTimeLimitSeconds": "30", "ContinueFlowExecution": "False"}, "Identifier": "27016824-0532-4844-8922-29f1a8d0b2b6", "Type": "TransferParticipantToThirdParty", "Transitions": {"NextAction": "bc366dad-e400-4987-beca-ff2e949479b2", "Errors": [{"NextAction": "bc366dad-e400-4987-beca-ff2e949479b2", "ErrorType": "NoMatchingError"}]}}, {"Parameters": {"ThirdPartyPhoneNumber": "$.External.Flag_DeliveryId_NextActionValue", "ThirdPartyConnectionTimeLimitSeconds": "30", "ContinueFlowExecution": "False", "CallerId": {"Number": "$.Queue.OutboundCallerId.Address"}}, "Identifier": "bc366dad-e400-4987-beca-ff2e949479b2", "Type": "TransferParticipantToThirdParty", "Transitions": {"NextAction": "fb1c4dd7-7307-46e6-ad05-1756ebffb424", "Errors": [{"NextAction": "fb1c4dd7-7307-46e6-ad05-1756ebffb424", "ErrorType": "NoMatchingError"}]}}, {"Parameters": {"FlowLoggingBehavior": "Enabled"}, "Identifier": "b8346fd4-3e2d-497a-a4e6-af820e204381", "Type": "UpdateFlowLoggingBehavior", "Transitions": {"NextAction": "21cad021-fc67-4623-8c5d-0ed432aa6ef9"}}, {"Parameters": {"FlowAttributes": {"Log_ERROR": {"Value": "Unable to goto Flow from DeliveryId Config as Next Action."}}}, "Identifier": "0714d88a-f836-40c9-8762-38a6958e4b0c", "Type": "UpdateFlowAttributes", "Transitions": {"NextAction": "0ea43059-94cb-4dbf-9397-32229a71933f", "Errors": [{"NextAction": "0ea43059-94cb-4dbf-9397-32229a71933f", "ErrorType": "NoMatchingError"}]}}, {"Parameters": {"ContactFlowId": "${iConnectContactflowVoiceCoreSteeringMenu}"}, "Identifier": "d150506c-ca09-47ee-b1fc-de86f38fdd00", "Type": "TransferToFlow", "Transitions": {"NextAction": "0ea43059-94cb-4dbf-9397-32229a71933f", "Errors": [{"NextAction": "0ea43059-94cb-4dbf-9397-32229a71933f", "ErrorType": "NoMatchingError"}]}}, {"Parameters": {"FlowAttributes": {"Log_WARN": {"Value": "Unable to Dial out to external number $.External.Flag_DeliveryId_NextActionValue"}}}, "Identifier": "fb1c4dd7-7307-46e6-ad05-1756ebffb424", "Type": "UpdateFlowAttributes", "Transitions": {"NextAction": "0ea43059-94cb-4dbf-9397-32229a71933f", "Errors": [{"NextAction": "0ea43059-94cb-4dbf-9397-32229a71933f", "ErrorType": "NoMatchingError"}]}}, {"Parameters": {"FlowAttributes": {"Log_WARN": {"Value": "Unable to Set Working Queue from DeliveryId Config as Next Action."}}}, "Identifier": "76cdd1fb-6a98-402b-a3cb-b15a132b682d", "Type": "UpdateFlowAttributes", "Transitions": {"NextAction": "0ea43059-94cb-4dbf-9397-32229a71933f", "Errors": [{"NextAction": "0ea43059-94cb-4dbf-9397-32229a71933f", "ErrorType": "NoMatchingError"}]}}, {"Parameters": {"QueueId": "$.External.Flag_DeliveryId_NextActionValue"}, "Identifier": "a9e57e87-a9d4-44f8-afde-0c688be8900c", "Type": "UpdateContactTargetQueue", "Transitions": {"NextAction": "0ea43059-94cb-4dbf-9397-32229a71933f", "Errors": [{"NextAction": "76cdd1fb-6a98-402b-a3cb-b15a132b682d", "ErrorType": "NoMatchingError"}]}}, {"Parameters": {"ContactFlowId": "${iConnectContactflowVoiceCorePreQueue}"}, "Identifier": "0ea43059-94cb-4dbf-9397-32229a71933f", "Type": "TransferToFlow", "Transitions": {"NextAction": "2642cd55-fd6c-407f-b8f6-b1235c7863bf", "Errors": [{"NextAction": "2642cd55-fd6c-407f-b8f6-b1235c7863bf", "ErrorType": "NoMatchingError"}]}}, {"Parameters": {}, "Identifier": "2642cd55-fd6c-407f-b8f6-b1235c7863bf", "Type": "DisconnectParticipant", "Transitions": {}}, {"Parameters": {"ContactFlowId": "$.Attributes.Flow_GetArn_Arn"}, "Identifier": "e2bfd1d3-4689-494d-9da6-67240f64456c", "Type": "TransferToFlow", "Transitions": {"NextAction": "0714d88a-f836-40c9-8762-38a6958e4b0c", "Errors": [{"NextAction": "0714d88a-f836-40c9-8762-38a6958e4b0c", "ErrorType": "NoMatchingError"}]}}, {"Parameters": {"Attributes": {"Flag_Flow_SteeringMenu": "$.External.Flag_DeliveryId_NextActionValue"}, "TargetContact": "Current"}, "Identifier": "4157dfe8-5e1f-4a5f-a767-7d76200c002f", "Type": "UpdateContactAttributes", "Transitions": {"NextAction": "d150506c-ca09-47ee-b1fc-de86f38fdd00", "Errors": [{"NextAction": "d150506c-ca09-47ee-b1fc-de86f38fdd00", "ErrorType": "NoMatchingError"}]}}, {"Parameters": {"ComparisonValue": "$.CustomerEndpoint.Address"}, "Identifier": "b263f048-aedb-41a7-9302-487b1167b7f4", "Type": "Compare", "Transitions": {"NextAction": "bc366dad-e400-4987-beca-ff2e949479b2", "Conditions": [{"NextAction": "27016824-0532-4844-8922-29f1a8d0b2b6", "Condition": {"Operator": "TextStartsWith", "Operands": ["+"]}}], "Errors": [{"NextAction": "bc366dad-e400-4987-beca-ff2e949479b2", "ErrorType": "NoMatchingCondition"}]}}, {"Parameters": {"FlowAttributes": {"Log_ERROR": {"Value": "DeliveryId Next Action Type is not valid: $.External.Flag_DeliveryId_NextActionType"}}}, "Identifier": "5439a893-5786-4f89-8399-3568dba83dde", "Type": "UpdateFlowAttributes", "Transitions": {"NextAction": "0ea43059-94cb-4dbf-9397-32229a71933f", "Errors": [{"NextAction": "0ea43059-94cb-4dbf-9397-32229a71933f", "ErrorType": "NoMatchingError"}]}}, {"Parameters": {"ComparisonValue": "$.External.Flag_DeliveryId_NextActionValue"}, "Identifier": "ee768dc5-695d-483a-907b-732bbc095ba2", "Type": "Compare", "Transitions": {"NextAction": "a9e57e87-a9d4-44f8-afde-0c688be8900c", "Conditions": [{"NextAction": "0ea43059-94cb-4dbf-9397-32229a71933f", "Condition": {"Operator": "Equals", "Operands": ["$.Attributes.Null"]}}], "Errors": [{"NextAction": "a9e57e87-a9d4-44f8-afde-0c688be8900c", "ErrorType": "NoMatchingCondition"}]}}, {"Parameters": {}, "Identifier": "757492ea-6d47-4b22-b7a8-c67cd57034f5", "Type": "DisconnectParticipant", "Transitions": {}}, {"Parameters": {"Attributes": {"Prompt_Flow_TempModuleAttribute": "$.External.Flag_DeliveryId_NextActionValue"}, "TargetContact": "Current"}, "Identifier": "6f17a6e7-cbca-43a1-a61a-e9543235020d", "Type": "UpdateContactAttributes", "Transitions": {"NextAction": "c67a1f1e-2287-474f-a000-3c67a2330aa4", "Errors": [{"NextAction": "c67a1f1e-2287-474f-a000-3c67a2330aa4", "ErrorType": "NoMatchingError"}]}}, {"Parameters": {"FlowModuleId": "${iConnectContactFlowModuleCloudInteractCorePlayPrompt}"}, "Identifier": "c67a1f1e-2287-474f-a000-3c67a2330aa4", "Type": "InvokeFlowModule", "Transitions": {"NextAction": "757492ea-6d47-4b22-b7a8-c67cd57034f5", "Errors": [{"NextAction": "757492ea-6d47-4b22-b7a8-c67cd57034f5", "ErrorType": "NoMatchingError"}]}}, {"Parameters": {"FlowAttributes": {"Log_ERROR": {"Value": "Unable to Set Working Queue from DeliveryId Config."}}}, "Identifier": "b2d9a2d3-1fd0-4c07-b495-ab13e0f0f053", "Type": "UpdateFlowAttributes", "Transitions": {"NextAction": "9243e003-4096-431c-a771-d0bb069eb277", "Errors": [{"NextAction": "9243e003-4096-431c-a771-d0bb069eb277", "ErrorType": "NoMatchingError"}]}}, {"Parameters": {"Attributes": {"Prompt_Flow_TempModuleAttribute": "$.External.Prompt_DeliveryId_Welcome"}, "TargetContact": "Current"}, "Identifier": "579eadf9-c834-4bee-a4a4-679b49bb5efe", "Type": "UpdateContactAttributes", "Transitions": {"NextAction": "a4852dbe-5b8a-4867-a8ae-f2315954d24c", "Errors": [{"NextAction": "a4852dbe-5b8a-4867-a8ae-f2315954d24c", "ErrorType": "NoMatchingError"}]}}, {"Parameters": {"ComparisonValue": "$.External.Prompt_DeliveryId_Welcome"}, "Identifier": "9243e003-4096-431c-a771-d0bb069eb277", "Type": "Compare", "Transitions": {"NextAction": "579eadf9-c834-4bee-a4a4-679b49bb5efe", "Conditions": [{"NextAction": "da015edd-63db-4125-be54-9c7080eec344", "Condition": {"Operator": "Equals", "Operands": ["$.Attributes.Null"]}}], "Errors": [{"NextAction": "579eadf9-c834-4bee-a4a4-679b49bb5efe", "ErrorType": "NoMatchingCondition"}]}}, {"Parameters": {"FlowModuleId": "${iConnectContactFlowModuleCloudInteractCorePlayPrompt}"}, "Identifier": "a4852dbe-5b8a-4867-a8ae-f2315954d24c", "Type": "InvokeFlowModule", "Transitions": {"NextAction": "da015edd-63db-4125-be54-9c7080eec344", "Errors": [{"NextAction": "da015edd-63db-4125-be54-9c7080eec344", "ErrorType": "NoMatchingError"}]}}, {"Parameters": {"ComparisonValue": "$.External.Prompt_DeliveryId_WelcomeAdHoc"}, "Identifier": "da015edd-63db-4125-be54-9c7080eec344", "Type": "Compare", "Transitions": {"NextAction": "ffba1103-489c-4ea7-a1be-454b982d7b2b", "Conditions": [{"NextAction": "99f173d2-8120-4dd7-ad2c-e433f89fb74b", "Condition": {"Operator": "Equals", "Operands": ["$.Attributes.Null"]}}], "Errors": [{"NextAction": "ffba1103-489c-4ea7-a1be-454b982d7b2b", "ErrorType": "NoMatchingCondition"}]}}, {"Parameters": {"ComparisonValue": "$.External.Flag_DeliveryId_NextActionType"}, "Identifier": "99f173d2-8120-4dd7-ad2c-e433f89fb74b", "Type": "Compare", "Transitions": {"NextAction": "5439a893-5786-4f89-8399-3568dba83dde", "Conditions": [{"NextAction": "4157dfe8-5e1f-4a5f-a767-7d76200c002f", "Condition": {"Operator": "Equals", "Operands": ["steeringmenu"]}}, {"NextAction": "e2bfd1d3-4689-494d-9da6-67240f64456c", "Condition": {"Operator": "Equals", "Operands": ["flow"]}}, {"NextAction": "6f17a6e7-cbca-43a1-a61a-e9543235020d", "Condition": {"Operator": "Equals", "Operands": ["disconnect"]}}, {"NextAction": "b263f048-aedb-41a7-9302-487b1167b7f4", "Condition": {"Operator": "Equals", "Operands": ["external"]}}, {"NextAction": "ee768dc5-695d-483a-907b-732bbc095ba2", "Condition": {"Operator": "Equals", "Operands": ["queue"]}}], "Errors": [{"NextAction": "5439a893-5786-4f89-8399-3568dba83dde", "ErrorType": "NoMatchingCondition"}]}}, {"Parameters": {"Attributes": {"Prompt_Flow_TempModuleAttribute": "$.External.Prompt_DeliveryId_WelcomeAdHoc"}, "TargetContact": "Current"}, "Identifier": "ffba1103-489c-4ea7-a1be-454b982d7b2b", "Type": "UpdateContactAttributes", "Transitions": {"NextAction": "bc8f86e5-a736-4b4c-8d60-a40399dfbe2d", "Errors": [{"NextAction": "bc8f86e5-a736-4b4c-8d60-a40399dfbe2d", "ErrorType": "NoMatchingError"}]}}, {"Parameters": {"FlowModuleId": "${iConnectContactFlowModuleCloudInteractCorePlayPrompt}"}, "Identifier": "bc8f86e5-a736-4b4c-8d60-a40399dfbe2d", "Type": "InvokeFlowModule", "Transitions": {"NextAction": "99f173d2-8120-4dd7-ad2c-e433f89fb74b", "Errors": [{"NextAction": "99f173d2-8120-4dd7-ad2c-e433f89fb74b", "ErrorType": "NoMatchingError"}]}}, {"Parameters": {}, "Identifier": "83b76e76-52cc-4732-81ff-1519b0c0f132", "Type": "DisconnectParticipant", "Transitions": {}}, {"Parameters": {"Text": "Sorry, their has been a critical error, please try again later."}, "Identifier": "2e9a94dc-3fd6-485e-a0c9-47d8cf2477fd", "Type": "MessageParticipant", "Transitions": {"NextAction": "83b76e76-52cc-4732-81ff-1519b0c0f132", "Errors": [{"NextAction": "83b76e76-52cc-4732-81ff-1519b0c0f132", "ErrorType": "NoMatchingError"}]}}, {"Parameters": {"TextToSpeechVoice": "Joanna"}, "Identifier": "21cad021-fc67-4623-8c5d-0ed432aa6ef9", "Type": "UpdateContactTextToSpeechVoice", "Transitions": {"NextAction": "81e9b39c-2025-400f-b533-280b13d715e0"}}, {"Parameters": {"LanguageCode": "en-US"}, "Identifier": "81e9b39c-2025-400f-b533-280b13d715e0", "Type": "UpdateContactData", "Transitions": {"NextAction": "1804d43f-0b41-4a08-b13f-71ecf7edb1b4", "Errors": [{"NextAction": "1804d43f-0b41-4a08-b13f-71ecf7edb1b4", "ErrorType": "NoMatchingError"}]}}, {"Parameters": {"QueueId": "$.External.Queue_DeliveryId_DefaultQueue"}, "Identifier": "3cdb26e7-57b8-4ccf-b4e8-11626a01466f", "Type": "UpdateContactTargetQueue", "Transitions": {"NextAction": "9243e003-4096-431c-a771-d0bb069eb277", "Errors": [{"NextAction": "b2d9a2d3-1fd0-4c07-b495-ab13e0f0f053", "ErrorType": "NoMatchingError"}]}}, {"Parameters": {"FlowAttributes": {"Log_CRITICAL": {"Value": "Initiation Config failed, sending to PreQueue Flow"}}}, "Identifier": "c17aae39-eea0-40ab-a87b-757b43c4bf2a", "Type": "UpdateFlowAttributes", "Transitions": {"NextAction": "2e9a94dc-3fd6-485e-a0c9-47d8cf2477fd", "Errors": [{"NextAction": "2e9a94dc-3fd6-485e-a0c9-47d8cf2477fd", "ErrorType": "NoMatchingError"}]}}, {"Parameters": {"LambdaFunctionARN": "${iLambdaLambdafunction}", "InvocationTimeLimitSeconds": "8", "LambdaInvocationAttributes": {"Primary_Key": "$.SystemEndpoint.Address", "Resource_Type": "DeliveryId"}, "ResponseValidation": {"ResponseType": "STRING_MAP"}}, "Identifier": "1804d43f-0b41-4a08-b13f-71ecf7edb1b4", "Type": "InvokeLambdaFunction", "Transitions": {"NextAction": "3cdb26e7-57b8-4ccf-b4e8-11626a01466f", "Errors": [{"NextAction": "c17aae39-eea0-40ab-a87b-757b43c4bf2a", "ErrorType": "NoMatchingError"}]}}]}
        - iConnectContactflowVoiceCoreSteeringMenu: !GetAtt rConnectContactFlowCloudInteractCoreSteeringMenu.ContactFlowArn
          iConnectContactflowVoiceCorePreQueue: !GetAtt rConnectContactFlowCloudInteractCorePreQueue.ContactFlowArn
          iLambdaLambdafunction: !GetAtt rLambdaConnectGetFlowData.Arn
          iConnectContactFlowModuleCloudInteractCorePlayPrompt: !GetAtt rConnectContactFlowModuleCloudInteractCorePlayPrompt.ContactFlowModuleArn

  rConnectContactFlowCloudInteractCorePreQueue:
    Type: AWS::Connect::ContactFlow
    Properties:
      Description: Final Flow before placing the contact into the queue.
      Name: CloudInteract_Core_PreQueue
      State: ACTIVE
      Type: CONTACT_FLOW
      InstanceArn: !Ref pConnectInstanceArn
      Content: !Sub
        - |
          {"Version": "2019-10-30", "StartAction": "a98a95c7-cce1-4d93-bf2c-f0a46aae1a62", "Metadata": {"entryPointPosition": {"x": 43.2, "y": 155.2}, "ActionMetadata": {"11ab1fff-bd76-4324-ad64-8a5981e04ae7": {"position": {"x": 1770.4, "y": 760}}, "2522266b-5c6b-411a-8051-7179dbd287f5": {"position": {"x": 1297.6, "y": 720}, "parameters": {"Attributes": {"Prompt_Flow_TempModuleAttribute": {"useDynamic": true}}}, "dynamicParams": ["Prompt_Flow_TempModuleAttribute"]}, "6e3d5208-eda6-47e3-bf4b-8182f85e2a9c": {"position": {"x": 1536.8, "y": 716}, "parameters": {"FlowModuleId": {"displayName": "CloudInteract_Core_PlayPrompt"}}, "contactFlowModuleName": "CloudInteract_Core_PlayPrompt"}, "8ba9e556-9faf-431e-b164-a17440d37f5c": {"position": {"x": 1297.6, "y": 548}, "parameters": {"ContactFlowId": {"useDynamic": true}}, "useDynamic": true}, "2fa0a224-a749-4c39-a7f1-19ac74bc6cd4": {"position": {"x": 2647.2, "y": 668.8}}, "3324a1aa-74c4-4be2-9821-0a8222f9f642": {"position": {"x": 1537.6, "y": 532.8}}, "8a7e32dd-bc38-427d-9bd8-a879c1f637d5": {"position": {"x": 176, "y": 623.2}}, "7fafaf09-949a-4b31-bda1-cbc747a9f79b": {"position": {"x": 1292.8, "y": 953.6}}, "dd413ed1-2896-45d2-89df-9fe151dff979": {"position": {"x": 2095.2, "y": 846.4}}, "d3eed104-fdd7-4705-952d-f704aa076f51": {"position": {"x": 1036, "y": 540.8}, "conditions": [], "conditionMetadata": [{"id": "58df286a-bd56-41e3-8b4d-4273c8c9bb6b", "operator": {"name": "Equals", "value": "Equals", "shortDisplay": "="}, "value": "flow"}, {"id": "2cb945df-53cc-426d-99f2-985be8bffcfd", "operator": {"name": "Equals", "value": "Equals", "shortDisplay": "="}, "value": "disconnect"}, {"id": "253cdcbb-619d-46e5-82f5-4c902eb1bea0", "operator": {"name": "Equals", "value": "Equals", "shortDisplay": "="}, "value": "queue"}]}, "43974b73-5ca4-459f-9162-1a2607cb43b0": {"position": {"x": 2414.4, "y": 684}}, "25ba3ac4-59c2-4e5d-a8de-0384b931129b": {"position": {"x": 1252.8, "y": 1162.4}}, "1772a386-a80d-45c1-a39c-c3e31b04347f": {"position": {"x": 487.2, "y": 1786.4}}, "21efc8a5-f3fa-4651-a5b5-9b11781956bf": {"position": {"x": 181.6, "y": 956.8}, "parameters": {"FlowModuleId": {"displayName": "CloudInteract_Core_RecordingAnalyticsBehavior"}}, "contactFlowModuleName": "CloudInteract_Core_RecordingAnalyticsBehavior"}, "6877fa3e-c38e-4b7e-82cf-5066b2c26159": {"position": {"x": 187.2, "y": 1750.4}}, "4bce6691-997e-4ddd-b627-ddeffc69734a": {"position": {"x": 177.6, "y": 1239.2}, "conditions": [], "conditionMetadata": [{"id": "c8f0eeb4-71fe-4fe9-b897-6d39646ff881", "operator": {"name": "Equals", "value": "Equals", "shortDisplay": "="}, "value": "$.Attributes.Null"}]}, "4bc61a3b-fa6c-4dd6-97a3-51671c2ad8d5": {"position": {"x": 445.6, "y": 1243.2}, "parameters": {"Attributes": {"Prompt_Flow_TempModuleAttribute": {"useDynamic": true}}}, "dynamicParams": ["Prompt_Flow_TempModuleAttribute"]}, "1e070dc7-a46a-4aa5-8305-f953af78da16": {"position": {"x": 688.8, "y": 1241.6}, "parameters": {"FlowModuleId": {"displayName": "CloudInteract_Core_PlayPrompt"}}, "contactFlowModuleName": "CloudInteract_Core_PlayPrompt"}, "b4fb3081-221d-4330-a829-655e2f3f97d2": {"position": {"x": 172, "y": 1485.6}, "parameters": {"EventHooks": {"AgentWhisper": {"displayName": "CloudInteract_Core_WhisperAgent"}}}, "contactFlow": {"text": "CloudInteract_Core_WhisperAgent", "id": "${iConnectContactflowCloudInteractCoreWhisperAgent}"}, "customerOrAgent": false}, "66890142-dab4-435f-9128-f4d3ea2905ba": {"position": {"x": 442.4, "y": 160}, "parameters": {"Attributes": {"Flag_Queue_ContactRecording": {"useDynamic": true}, "Flag_Queue_ScreenRecording": {"useDynamic": true}}}, "dynamicParams": ["Flag_Queue_ContactRecording", "Flag_Queue_ScreenRecording"]}, "06806cf6-40a4-4015-9387-efe7398389f4": {"position": {"x": 440.8, "y": 372}}, "8c6aad6a-fd12-45e6-a553-1bc3889ded2f": {"position": {"x": 1790.4, "y": 902.4}, "parameters": {"QueueId": {"useDynamic": true}}, "useDynamic": true}, "a98a95c7-cce1-4d93-bf2c-f0a46aae1a62": {"position": {"x": 190.4, "y": 153.6}, "parameters": {"LambdaFunctionARN": {"displayName": "${iLambdaLambdafunction}"}, "LambdaInvocationAttributes": {"Primary_Key": {"useDynamic": true}}}, "dynamicMetadata": {"Primary_Key": true, "Resource_Type": false}}}, "Annotations": []}, "Actions": [{"Parameters": {}, "Identifier": "11ab1fff-bd76-4324-ad64-8a5981e04ae7", "Type": "DisconnectParticipant", "Transitions": {}}, {"Parameters": {"Attributes": {"Prompt_Flow_TempModuleAttribute": "$.External.Flag_Queue_OutOfHourActionValue"}, "TargetContact": "Current"}, "Identifier": "2522266b-5c6b-411a-8051-7179dbd287f5", "Type": "UpdateContactAttributes", "Transitions": {"NextAction": "6e3d5208-eda6-47e3-bf4b-8182f85e2a9c", "Errors": [{"NextAction": "6e3d5208-eda6-47e3-bf4b-8182f85e2a9c", "ErrorType": "NoMatchingError"}]}}, {"Parameters": {"FlowModuleId": "${iConnectContactFlowModuleCloudInteractCorePlayPrompt}"}, "Identifier": "6e3d5208-eda6-47e3-bf4b-8182f85e2a9c", "Type": "InvokeFlowModule", "Transitions": {"NextAction": "11ab1fff-bd76-4324-ad64-8a5981e04ae7", "Errors": [{"NextAction": "11ab1fff-bd76-4324-ad64-8a5981e04ae7", "ErrorType": "NoMatchingError"}]}}, {"Parameters": {"ContactFlowId": "$.External.Flag_Queue_OutOfHourActionValue"}, "Identifier": "8ba9e556-9faf-431e-b164-a17440d37f5c", "Type": "TransferToFlow", "Transitions": {"NextAction": "3324a1aa-74c4-4be2-9821-0a8222f9f642", "Errors": [{"NextAction": "3324a1aa-74c4-4be2-9821-0a8222f9f642", "ErrorType": "NoMatchingError"}]}}, {"Parameters": {}, "Identifier": "2fa0a224-a749-4c39-a7f1-19ac74bc6cd4", "Type": "DisconnectParticipant", "Transitions": {}}, {"Parameters": {"FlowAttributes": {"Log_ERROR": {"Value": "Unable to goto Flow from DeliveryId Config as Next Action."}}}, "Identifier": "3324a1aa-74c4-4be2-9821-0a8222f9f642", "Type": "UpdateFlowAttributes", "Transitions": {"NextAction": "43974b73-5ca4-459f-9162-1a2607cb43b0", "Errors": [{"NextAction": "43974b73-5ca4-459f-9162-1a2607cb43b0", "ErrorType": "NoMatchingError"}]}}, {"Parameters": {}, "Identifier": "8a7e32dd-bc38-427d-9bd8-a879c1f637d5", "Type": "CheckHoursOfOperation", "Transitions": {"NextAction": "21efc8a5-f3fa-4651-a5b5-9b11781956bf", "Conditions": [{"NextAction": "21efc8a5-f3fa-4651-a5b5-9b11781956bf", "Condition": {"Operator": "Equals", "Operands": ["True"]}}, {"NextAction": "d3eed104-fdd7-4705-952d-f704aa076f51", "Condition": {"Operator": "Equals", "Operands": ["False"]}}], "Errors": [{"NextAction": "21efc8a5-f3fa-4651-a5b5-9b11781956bf", "ErrorType": "NoMatchingError"}]}}, {"Parameters": {"LoopCount": "3"}, "Identifier": "7fafaf09-949a-4b31-bda1-cbc747a9f79b", "Type": "Loop", "Transitions": {"NextAction": "43974b73-5ca4-459f-9162-1a2607cb43b0", "Conditions": [{"NextAction": "8c6aad6a-fd12-45e6-a553-1bc3889ded2f", "Condition": {"Operator": "Equals", "Operands": ["ContinueLooping"]}}, {"NextAction": "43974b73-5ca4-459f-9162-1a2607cb43b0", "Condition": {"Operator": "Equals", "Operands": ["DoneLooping"]}}]}}, {"Parameters": {"FlowAttributes": {"Log_WARN": {"Value": "Unable to Set Working Queue from DeliveryId Config as Next Action."}}}, "Identifier": "dd413ed1-2896-45d2-89df-9fe151dff979", "Type": "UpdateFlowAttributes", "Transitions": {"NextAction": "43974b73-5ca4-459f-9162-1a2607cb43b0", "Errors": [{"NextAction": "43974b73-5ca4-459f-9162-1a2607cb43b0", "ErrorType": "NoMatchingError"}]}}, {"Parameters": {"ComparisonValue": "$.External.Flag_Queue_OutOfHourActionType"}, "Identifier": "d3eed104-fdd7-4705-952d-f704aa076f51", "Type": "Compare", "Transitions": {"NextAction": "25ba3ac4-59c2-4e5d-a8de-0384b931129b", "Conditions": [{"NextAction": "8ba9e556-9faf-431e-b164-a17440d37f5c", "Condition": {"Operator": "Equals", "Operands": ["flow"]}}, {"NextAction": "2522266b-5c6b-411a-8051-7179dbd287f5", "Condition": {"Operator": "Equals", "Operands": ["disconnect"]}}, {"NextAction": "7fafaf09-949a-4b31-bda1-cbc747a9f79b", "Condition": {"Operator": "Equals", "Operands": ["queue"]}}], "Errors": [{"NextAction": "25ba3ac4-59c2-4e5d-a8de-0384b931129b", "ErrorType": "NoMatchingCondition"}]}}, {"Parameters": {"Text": "Sorry, their has been a critical error, please try again later."}, "Identifier": "43974b73-5ca4-459f-9162-1a2607cb43b0", "Type": "MessageParticipant", "Transitions": {"NextAction": "2fa0a224-a749-4c39-a7f1-19ac74bc6cd4", "Errors": [{"NextAction": "2fa0a224-a749-4c39-a7f1-19ac74bc6cd4", "ErrorType": "NoMatchingError"}]}}, {"Parameters": {"FlowAttributes": {"Log_ERROR": {"Value": "Queue Next Action Type is not valid: $.External.Flag_Queue_NextActionType"}}}, "Identifier": "25ba3ac4-59c2-4e5d-a8de-0384b931129b", "Type": "UpdateFlowAttributes", "Transitions": {"NextAction": "43974b73-5ca4-459f-9162-1a2607cb43b0", "Errors": [{"NextAction": "43974b73-5ca4-459f-9162-1a2607cb43b0", "ErrorType": "NoMatchingError"}]}}, {"Parameters": {}, "Identifier": "1772a386-a80d-45c1-a39c-c3e31b04347f", "Type": "DisconnectParticipant", "Transitions": {}}, {"Parameters": {"FlowModuleId": "${iConnectContactFlowModuleCloudInteractCoreRecordingAnalyticsBehavior}"}, "Identifier": "21efc8a5-f3fa-4651-a5b5-9b11781956bf", "Type": "InvokeFlowModule", "Transitions": {"NextAction": "4bce6691-997e-4ddd-b627-ddeffc69734a", "Errors": [{"NextAction": "4bce6691-997e-4ddd-b627-ddeffc69734a", "ErrorType": "NoMatchingError"}]}}, {"Parameters": {}, "Identifier": "6877fa3e-c38e-4b7e-82cf-5066b2c26159", "Type": "TransferContactToQueue", "Transitions": {"NextAction": "1772a386-a80d-45c1-a39c-c3e31b04347f", "Errors": [{"NextAction": "1772a386-a80d-45c1-a39c-c3e31b04347f", "ErrorType": "QueueAtCapacity"}, {"NextAction": "1772a386-a80d-45c1-a39c-c3e31b04347f", "ErrorType": "NoMatchingError"}]}}, {"Parameters": {"ComparisonValue": "$.External.Prompt_Queue_PreQueue"}, "Identifier": "4bce6691-997e-4ddd-b627-ddeffc69734a", "Type": "Compare", "Transitions": {"NextAction": "4bc61a3b-fa6c-4dd6-97a3-51671c2ad8d5", "Conditions": [{"NextAction": "b4fb3081-221d-4330-a829-655e2f3f97d2", "Condition": {"Operator": "Equals", "Operands": ["$.Attributes.Null"]}}], "Errors": [{"NextAction": "4bc61a3b-fa6c-4dd6-97a3-51671c2ad8d5", "ErrorType": "NoMatchingCondition"}]}}, {"Parameters": {"Attributes": {"Prompt_Flow_TempModuleAttribute": "$.External.Prompt_Queue_PreQueue"}, "TargetContact": "Current"}, "Identifier": "4bc61a3b-fa6c-4dd6-97a3-51671c2ad8d5", "Type": "UpdateContactAttributes", "Transitions": {"NextAction": "1e070dc7-a46a-4aa5-8305-f953af78da16", "Errors": [{"NextAction": "b4fb3081-221d-4330-a829-655e2f3f97d2", "ErrorType": "NoMatchingError"}]}}, {"Parameters": {"FlowModuleId": "${iConnectContactFlowModuleCloudInteractCorePlayPrompt}"}, "Identifier": "1e070dc7-a46a-4aa5-8305-f953af78da16", "Type": "InvokeFlowModule", "Transitions": {"NextAction": "b4fb3081-221d-4330-a829-655e2f3f97d2", "Errors": [{"NextAction": "b4fb3081-221d-4330-a829-655e2f3f97d2", "ErrorType": "NoMatchingError"}]}}, {"Parameters": {"EventHooks": {"AgentWhisper": "${iConnectContactflowCloudInteractCoreWhisperAgent}"}}, "Identifier": "b4fb3081-221d-4330-a829-655e2f3f97d2", "Type": "UpdateContactEventHooks", "Transitions": {"NextAction": "6877fa3e-c38e-4b7e-82cf-5066b2c26159", "Errors": [{"NextAction": "6877fa3e-c38e-4b7e-82cf-5066b2c26159", "ErrorType": "NoMatchingError"}]}}, {"Parameters": {"Attributes": {"Prompt_Queue_WhisperAgent": "$.External.Prompt_Queue_WhisperAgent", "Prompt_Queue_WhisperCustomer": "$.External.Prompt_Queue_WhisperCustomer", "Flag_Queue_ContactRecording": "$.External.Flag_Queue_ContactRecording", "Flag_Queue_ScreenRecording": "$.External.Flag_Queue_ScreenRecording", "Flag_Queue_Analytics": "$.External.Flag_Queue_Analytics", "Flag_Queue_Redaction": "$.External.Flag_Queue_Redaction"}, "TargetContact": "Current"}, "Identifier": "66890142-dab4-435f-9128-f4d3ea2905ba", "Type": "UpdateContactAttributes", "Transitions": {"NextAction": "8a7e32dd-bc38-427d-9bd8-a879c1f637d5", "Errors": [{"NextAction": "8a7e32dd-bc38-427d-9bd8-a879c1f637d5", "ErrorType": "NoMatchingError"}]}}, {"Parameters": {"FlowAttributes": {"Log_CRITICAL": {"Value": "Queue Configuration not retrieved, trying to continue"}}}, "Identifier": "06806cf6-40a4-4015-9387-efe7398389f4", "Type": "UpdateFlowAttributes", "Transitions": {"NextAction": "8a7e32dd-bc38-427d-9bd8-a879c1f637d5", "Errors": [{"NextAction": "8a7e32dd-bc38-427d-9bd8-a879c1f637d5", "ErrorType": "NoMatchingError"}]}}, {"Parameters": {"QueueId": "$.Attributes.Flag_Queue_OutOfHourActionValue"}, "Identifier": "8c6aad6a-fd12-45e6-a553-1bc3889ded2f", "Type": "UpdateContactTargetQueue", "Transitions": {"NextAction": "a98a95c7-cce1-4d93-bf2c-f0a46aae1a62", "Errors": [{"NextAction": "dd413ed1-2896-45d2-89df-9fe151dff979", "ErrorType": "NoMatchingError"}]}}, {"Parameters": {"LambdaFunctionARN": "${iLambdaLambdafunction}", "InvocationTimeLimitSeconds": "8", "LambdaInvocationAttributes": {"Primary_Key": "$.Queue.Name", "Resource_Type": "Queue"}, "ResponseValidation": {"ResponseType": "STRING_MAP"}}, "Identifier": "a98a95c7-cce1-4d93-bf2c-f0a46aae1a62", "Type": "InvokeLambdaFunction", "Transitions": {"NextAction": "66890142-dab4-435f-9128-f4d3ea2905ba", "Errors": [{"NextAction": "06806cf6-40a4-4015-9387-efe7398389f4", "ErrorType": "NoMatchingError"}]}}]}
        - iConnectContactflowCloudInteractCoreWhisperAgent: !GetAtt rConnectContactFlowCloudInteractCoreWhisperAgent.ContactFlowArn
          iLambdaLambdafunction: !GetAtt rLambdaConnectGetFlowData.Arn
          iConnectContactFlowModuleCloudInteractCorePlayPrompt: !GetAtt rConnectContactFlowModuleCloudInteractCorePlayPrompt.ContactFlowModuleArn
          iConnectContactFlowModuleCloudInteractCoreRecordingAnalyticsBehavior: !GetAtt rConnectContactFlowModuleCloudInteractCoreRecordingAnalyticsBehavior.ContactFlowModuleArn

  rConnectContactFlowCloudInteractCoreSteeringMenu:
    Type: AWS::Connect::ContactFlow
    Properties:
      Description: Allows Contacts to select a option from a menu to route their contact accordingly.
      Name: CloudInteract_Core_SteeringMenu
      State: ACTIVE
      Type: CONTACT_FLOW
      InstanceArn: !Ref pConnectInstanceArn
      Content: !Sub
        - |
          {"Version": "2019-10-30", "StartAction": "0a2bf7db-6ea8-4e4d-9e5b-3f5ba8d6777f", "Metadata": {"entryPointPosition": {"x": 125.6, "y": -374.4}, "ActionMetadata": {"e6e107fd-a6a7-4e1e-a4a8-30b1914f0841": {"position": {"x": 1380.8, "y": 1090.4}, "conditions": [], "conditionMetadata": [{"id": "10f0bdb5-b22e-4566-a662-7388edbd9e6e", "operator": {"name": "Equals", "value": "Equals", "shortDisplay": "="}, "value": "1"}, {"id": "778f31e0-69ae-4c25-9473-74b97123e970", "operator": {"name": "Equals", "value": "Equals", "shortDisplay": "="}, "value": "2"}, {"id": "e4010dbd-e411-4e38-99a3-8f52e4fd7afa", "operator": {"name": "Equals", "value": "Equals", "shortDisplay": "="}, "value": "3"}, {"id": "a15d6fa3-6f22-470e-af02-e008eabc2754", "operator": {"name": "Equals", "value": "Equals", "shortDisplay": "="}, "value": "4"}, {"id": "39a9b821-e787-4a0d-92dd-0ef7eace8018", "operator": {"name": "Equals", "value": "Equals", "shortDisplay": "="}, "value": "5"}, {"id": "be5b64f1-f6e5-4f84-bc2e-de8e1ddc9eea", "operator": {"name": "Equals", "value": "Equals", "shortDisplay": "="}, "value": "6"}, {"id": "fb2ac550-a722-4921-966e-df51d4a5f43f", "operator": {"name": "Equals", "value": "Equals", "shortDisplay": "="}, "value": "7"}, {"id": "faeab0f0-c9b4-45a8-823a-b7ba82a61d45", "operator": {"name": "Equals", "value": "Equals", "shortDisplay": "="}, "value": "8"}, {"id": "d6829ff8-3083-4748-b5a1-853b7af2d7a1", "operator": {"name": "Equals", "value": "Equals", "shortDisplay": "="}, "value": "9"}, {"id": "6a01551b-6c35-43a6-a26c-403263b946c4", "operator": {"name": "Equals", "value": "Equals", "shortDisplay": "="}, "value": "0"}, {"id": "d82f58f7-6290-4d1d-925d-75bbb4527d38", "operator": {"name": "Equals", "value": "Equals", "shortDisplay": "="}, "value": "*"}, {"id": "624aa6cc-e761-43f5-8674-24e31ede7994", "operator": {"name": "Equals", "value": "Equals", "shortDisplay": "="}, "value": "#"}, {"id": "8fd859c9-a63d-4beb-9757-d1426deb83c0", "operator": {"name": "Equals", "value": "Equals", "shortDisplay": "="}, "value": "Timeout"}]}, "c215b098-b596-4205-920f-50b755846cd6": {"position": {"x": 1612, "y": 277.6}, "parameters": {"Attributes": {"Flag_Flow_NextActionType": {"useDynamic": true}, "Flag_Flow_NextActionValue": {"useDynamic": true}, "Flag_Flow_NextActionPrompt": {"useDynamic": true}}}, "dynamicParams": ["Flag_Flow_NextActionType", "Flag_Flow_NextActionValue", "Flag_Flow_NextActionPrompt"]}, "b95e8e55-150f-4408-970a-33db87c14ff8": {"position": {"x": 1640.8, "y": 464.8}, "parameters": {"Attributes": {"Flag_Flow_NextActionType": {"useDynamic": true}, "Flag_Flow_NextActionValue": {"useDynamic": true}, "Flag_Flow_NextActionPrompt": {"useDynamic": true}}}, "dynamicParams": ["Flag_Flow_NextActionType", "Flag_Flow_NextActionValue", "Flag_Flow_NextActionPrompt"]}, "0d2bf40f-2b0e-430d-86a7-67ebac686ed3": {"position": {"x": 1673.6, "y": 672}, "parameters": {"Attributes": {"Flag_Flow_NextActionType": {"useDynamic": true}, "Flag_Flow_NextActionValue": {"useDynamic": true}, "Flag_Flow_NextActionPrompt": {"useDynamic": true}}}, "dynamicParams": ["Flag_Flow_NextActionType", "Flag_Flow_NextActionValue", "Flag_Flow_NextActionPrompt"]}, "64d13dfd-ca92-417c-822c-3718dfccf85b": {"position": {"x": 1702.4, "y": 884.8}, "parameters": {"Attributes": {"Flag_Flow_NextActionType": {"useDynamic": true}, "Flag_Flow_NextActionValue": {"useDynamic": true}, "Flag_Flow_NextActionPrompt": {"useDynamic": true}}}, "dynamicParams": ["Flag_Flow_NextActionType", "Flag_Flow_NextActionValue", "Flag_Flow_NextActionPrompt"]}, "ed74aa68-2e77-4611-878a-f9c1d2f75f8c": {"position": {"x": 1729.6, "y": 1084.8}, "parameters": {"Attributes": {"Flag_Flow_NextActionType": {"useDynamic": true}, "Flag_Flow_NextActionValue": {"useDynamic": true}, "Flag_Flow_NextActionPrompt": {"useDynamic": true}}}, "dynamicParams": ["Flag_Flow_NextActionType", "Flag_Flow_NextActionValue", "Flag_Flow_NextActionPrompt"]}, "0e14a2e8-3be3-4d55-a939-61ebe18b4eba": {"position": {"x": 1756.8, "y": 1284.8}, "parameters": {"Attributes": {"Flag_Flow_NextActionType": {"useDynamic": true}, "Flag_Flow_NextActionValue": {"useDynamic": true}, "Flag_Flow_NextActionPrompt": {"useDynamic": true}}}, "dynamicParams": ["Flag_Flow_NextActionType", "Flag_Flow_NextActionValue", "Flag_Flow_NextActionPrompt"]}, "45e54fa9-5c7d-4cf2-82cd-fca6da9b87c1": {"position": {"x": 1744, "y": 1483.2}, "parameters": {"Attributes": {"Flag_Flow_NextActionType": {"useDynamic": true}, "Flag_Flow_NextActionValue": {"useDynamic": true}, "Flag_Flow_NextActionPrompt": {"useDynamic": true}}}, "dynamicParams": ["Flag_Flow_NextActionType", "Flag_Flow_NextActionValue", "Flag_Flow_NextActionPrompt"]}, "328d2284-2a72-4dcd-9875-bca56cd3c09f": {"position": {"x": 1728.8, "y": 1679.2}, "parameters": {"Attributes": {"Flag_Flow_NextActionType": {"useDynamic": true}, "Flag_Flow_NextActionValue": {"useDynamic": true}, "Flag_Flow_NextActionPrompt": {"useDynamic": true}}}, "dynamicParams": ["Flag_Flow_NextActionType", "Flag_Flow_NextActionValue", "Flag_Flow_NextActionPrompt"]}, "54476530-6140-4407-88d9-7c6bb1994e95": {"position": {"x": 1711.2, "y": 1865.6}, "parameters": {"Attributes": {"Flag_Flow_NextActionType": {"useDynamic": true}, "Flag_Flow_NextActionValue": {"useDynamic": true}, "Flag_Flow_NextActionPrompt": {"useDynamic": true}}}, "dynamicParams": ["Flag_Flow_NextActionType", "Flag_Flow_NextActionValue", "Flag_Flow_NextActionPrompt"]}, "4b723861-f8d2-463a-af6f-2508ef661b64": {"position": {"x": 1695.2, "y": 2049.6}, "parameters": {"Attributes": {"Flag_Flow_NextActionType": {"useDynamic": true}, "Flag_Flow_NextActionValue": {"useDynamic": true}, "Flag_Flow_NextActionPrompt": {"useDynamic": true}}}, "dynamicParams": ["Flag_Flow_NextActionType", "Flag_Flow_NextActionValue", "Flag_Flow_NextActionPrompt"]}, "2f512687-f8e2-459b-90d3-4e43bef0b569": {"position": {"x": 1676.8, "y": 2230.4}, "parameters": {"Attributes": {"Flag_Flow_NextActionType": {"useDynamic": true}, "Flag_Flow_NextActionValue": {"useDynamic": true}, "Flag_Flow_NextActionPrompt": {"useDynamic": true}}}, "dynamicParams": ["Flag_Flow_NextActionType", "Flag_Flow_NextActionValue", "Flag_Flow_NextActionPrompt"]}, "0e1db850-c245-4bda-a95b-35b6b7ba477d": {"position": {"x": 1655.2, "y": 2417.6}, "parameters": {"Attributes": {"Flag_Flow_NextActionType": {"useDynamic": true}, "Flag_Flow_NextActionValue": {"useDynamic": true}, "Flag_Flow_NextActionPrompt": {"useDynamic": true}}}, "dynamicParams": ["Flag_Flow_NextActionType", "Flag_Flow_NextActionValue", "Flag_Flow_NextActionPrompt"]}, "f577a044-91f9-46c4-b054-533b9a7eea82": {"position": {"x": 1621.6, "y": 2607.2}, "parameters": {"Attributes": {"Flag_Flow_NextActionType": {"useDynamic": true}, "Flag_Flow_NextActionValue": {"useDynamic": true}, "Flag_Flow_NextActionPrompt": {"useDynamic": true}}}, "dynamicParams": ["Flag_Flow_NextActionType", "Flag_Flow_NextActionValue", "Flag_Flow_NextActionPrompt"]}, "d9456743-31f0-4b29-955c-d16a8c2adc1d": {"position": {"x": 686.4, "y": 748.8}, "parameters": {"PromptId": {"useDynamic": true}}, "useDynamic": true, "conditionMetadata": [], "countryCodePrefix": "+1"}, "e121513d-3255-4093-960a-3e00db5a0312": {"position": {"x": 688.8, "y": 929.6}, "parameters": {"Media": {"Uri": {"useDynamic": true}}}, "useDynamic": true, "conditionMetadata": [], "countryCodePrefix": "+1"}, "a7cb0aad-e1c8-4da4-ba4d-de9052c0273b": {"position": {"x": 672.8, "y": 1111.2}, "parameters": {"SSML": {"useDynamic": true}}, "useDynamic": true, "conditionMetadata": [], "countryCodePrefix": "+1"}, "45e32a72-5d88-4b11-9d3a-8003bdc0c5be": {"position": {"x": 648.8, "y": 1296}, "parameters": {"Text": {"useDynamic": true}}, "useDynamic": true, "conditionMetadata": [], "countryCodePrefix": "+1"}, "22648677-d617-4501-b265-8c85dbfb646d": {"position": {"x": 58.4, "y": 3302.4}, "dynamicParams": []}, "5b43481f-3e78-4a2c-b52b-893a79d1c38f": {"position": {"x": 80.8, "y": 3076}, "dynamicParams": []}, "9978fd36-4742-4321-9b8d-09d9df6d2966": {"position": {"x": 72.8, "y": 2860.8}, "dynamicParams": []}, "4c8da866-591e-4d6e-9243-991d1e3dfaa4": {"position": {"x": 41.6, "y": 2668}, "dynamicParams": []}, "Check for Pre-Menu Prompt": {"position": {"x": 411.2, "y": 255.2}, "isFriendlyName": true, "conditions": [], "conditionMetadata": [{"id": "e07b6b30-49c2-48d5-9ead-7468b5899eb8", "operator": {"name": "Equals", "value": "Equals", "shortDisplay": "="}, "value": "$.Attributes.Null"}]}, "Get Menu Config": {"position": {"x": 419.2, "y": -193.6}, "isFriendlyName": true, "parameters": {"LambdaFunctionARN": {"displayName": "${iLambdaLambdafunction}"}, "LambdaInvocationAttributes": {"Primary_Key": {"useDynamic": true}}}, "dynamicMetadata": {"Primary_Key": true, "Resource_Type": false}}, "dfb7b765-4e39-44b4-b935-309bc474fd98": {"position": {"x": 349.6, "y": 800}, "conditions": [], "conditionMetadata": [{"id": "f0fc4541-72fe-4108-9188-f4d66ca3f5ed", "operator": {"name": "Equals", "value": "Equals", "shortDisplay": "="}, "value": "$.Attributes.Null"}, {"id": "b628dab0-737e-4b95-b602-4e871cdfb6ed", "operator": {"name": "Starts with", "value": "StartsWith", "shortDisplay": "starts with"}, "value": "arn"}, {"id": "c8fdfed3-5935-479a-b828-e4d10445053e", "operator": {"name": "Starts with", "value": "StartsWith", "shortDisplay": "starts with"}, "value": "http"}, {"id": "6f0760a0-ddea-440d-af1e-c932778fb429", "operator": {"name": "Starts with", "value": "StartsWith", "shortDisplay": "starts with"}, "value": "<speak>"}]}, "ed5db109-f3bc-48b5-bd18-c2cd37eca391": {"position": {"x": 688.8, "y": 256}, "parameters": {"Attributes": {"Prompt_Flow_TempModuleAttribute": {"useDynamic": true}}}, "dynamicParams": ["Prompt_Flow_TempModuleAttribute"]}, "Play Pre-Menu Prompt": {"position": {"x": 932.8, "y": 252}, "isFriendlyName": true, "parameters": {"FlowModuleId": {"displayName": "CloudInteract_Core_PlayPrompt"}}, "contactFlowModuleName": "CloudInteract_Core_PlayPrompt"}, "1d4eb336-0896-439e-91c9-4e79c3ead591": {"position": {"x": 1184, "y": 594.4}}, "f0c22056-c5fa-43a4-97be-5aa104b485c9": {"position": {"x": 656.8, "y": 565.6}, "dynamicParams": []}, "7bfcd4ca-5b92-48dd-9199-bbd7ad906c38": {"position": {"x": 955.2, "y": 595.2}, "parameters": {"ContactFlowId": {"displayName": "CloudInteract_Core_PreQueue"}}, "ContactFlow": {"text": "CloudInteract_Core_PreQueue"}}, "2ae32127-0a36-4ac4-9c41-50c93d4ff941": {"position": {"x": 1179.2, "y": 1780.8}}, "dda47293-7b7a-4c1a-8990-9c946e510955": {"position": {"x": 919.2, "y": 1507.2}, "dynamicParams": []}, "3f10a16c-9d1c-4bc6-ab45-f6382f2aca52": {"position": {"x": 931.2, "y": 1744}, "parameters": {"ContactFlowId": {"displayName": "CloudInteract_Core_PreQueue"}}, "ContactFlow": {"text": "CloudInteract_Core_PreQueue"}}, "daa801f4-34d0-46e5-9ea6-95da5df376ca": {"position": {"x": 3676.8, "y": 1260}, "parameters": {"Attributes": {"Prompt_Flow_TempModuleAttribute": {"useDynamic": true}}}, "dynamicParams": ["Prompt_Flow_TempModuleAttribute"]}, "e8d4c563-c8b9-4d83-ad72-ce879c750511": {"position": {"x": 4139.2, "y": 1237.6}}, "Play Disconnect Message": {"position": {"x": 3902.4, "y": 1216}, "isFriendlyName": true, "parameters": {"FlowModuleId": {"displayName": "CloudInteract_Core_PlayPrompt"}}, "contactFlowModuleName": "CloudInteract_Core_PlayPrompt"}, "Check for Option Prompt": {"position": {"x": 2102.4, "y": 1188.8}, "isFriendlyName": true, "conditions": [], "conditionMetadata": [{"id": "51d4f15f-ffbb-461a-af8d-80a0df73b5a0", "operator": {"name": "Equals", "value": "Equals", "shortDisplay": "="}, "value": "$.Attributes.Null"}]}, "7df3c308-1857-4d96-b744-078fcc174305": {"position": {"x": 2313.6, "y": 1376.8}, "parameters": {"Attributes": {"Prompt_Flow_TempModuleAttribute": {"useDynamic": true}}}, "dynamicParams": ["Prompt_Flow_TempModuleAttribute"]}, "Play Option Prompt": {"position": {"x": 2553.6, "y": 1320}, "isFriendlyName": true, "parameters": {"FlowModuleId": {"displayName": "CloudInteract_Core_PlayPrompt"}}, "contactFlowModuleName": "CloudInteract_Core_PlayPrompt"}, "Check Disconnect Message": {"position": {"x": 3450.4, "y": 1332.8}, "isFriendlyName": true, "conditions": [], "conditionMetadata": [{"id": "490a6003-f75c-4fda-aa9d-e887fe9386ed", "operator": {"name": "Equals", "value": "Equals", "shortDisplay": "="}, "value": "$.Attributes.Null"}]}, "1cb69288-ff1c-43ed-bad0-92ba994eefba": {"position": {"x": 3713.6, "y": 1525.6}, "parameters": {"ThirdPartyPhoneNumber": {"useDynamic": true}}}, "ecd7f937-a1cd-4036-88e4-f03ebed1ef9f": {"position": {"x": 3460.8, "y": 1577.6}, "conditions": [], "conditionMetadata": [{"id": "7c29a37a-fe0b-468a-823a-1e4baebec90c", "operator": {"name": "Starts with", "value": "StartsWith", "shortDisplay": "starts with"}, "value": "+"}]}, "ccd29872-ba23-4631-8ad9-1ca96f018bee": {"position": {"x": 3752, "y": 1708.8}, "parameters": {"ThirdPartyPhoneNumber": {"useDynamic": true}, "CallerId": {"Number": {"inputOption": "dynamic"}}}, "callerIdSource": "dynamic"}, "9e6e9c1c-7164-490d-9456-90629450a5ff": {"position": {"x": 2811.2, "y": 2449.6}}, "2ab6c43b-7b04-483a-83a2-87bcc3a3be7a": {"position": {"x": 3435.2, "y": 1042.4}, "parameters": {"ContactFlowId": {"useDynamic": true}}, "useDynamic": true}, "0a2bf7db-6ea8-4e4d-9e5b-3f5ba8d6777f": {"position": {"x": 416, "y": -436}, "dynamicParams": []}, "8c4d879d-5d70-4abe-8b71-77677a9681db": {"position": {"x": 3384, "y": -352.8}, "parameters": {"Attributes": {"Flag_Flow_SteeringMenu": {"useDynamic": true}}}, "dynamicParams": ["Flag_Flow_SteeringMenu"]}, "f0516708-6f9b-402b-9799-9c471d459124": {"position": {"x": 3448.8, "y": 1846.4}, "parameters": {"QueueId": {"useDynamic": true}}, "useDynamic": true}, "4860dc19-b643-45b6-a884-fad205b67054": {"position": {"x": 3690.4, "y": 1972}}, "f94c8894-7539-4788-8815-4ac1af2f2367": {"position": {"x": 4028, "y": 1688.8}}, "772479c1-192d-440a-a575-5c1cb243a854": {"position": {"x": 3943.2, "y": 2215.2}}, "b501e678-548b-4279-92bf-666f85b5f58f": {"position": {"x": 3663.2, "y": 1012.8}}, "252ac0bb-137a-4eb5-aade-a99d1ddc9188": {"position": {"x": 4376, "y": 1647.2}, "parameters": {"ContactFlowId": {"displayName": "CloudInteract_Core_PreQueue"}}, "ContactFlow": {"text": "CloudInteract_Core_PreQueue"}}, "d6e5da29-a8da-438a-97ae-4734f2d74abd": {"position": {"x": 4621.6, "y": 1663.2}}, "17332d5c-8a8e-47c9-bea9-b1e47711e343": {"position": {"x": -192.8, "y": 3068}, "conditions": [], "conditionMetadata": [{"id": "9e69a28e-902f-4090-b8a2-b03ab2e80959", "operator": {"name": "Equals", "value": "Equals", "shortDisplay": "="}, "value": "1"}, {"id": "42ef5b47-cdf8-4daf-bd60-ebec73cf549a", "operator": {"name": "Equals", "value": "Equals", "shortDisplay": "="}, "value": "2"}, {"id": "bf3ab718-4117-4984-8995-341c58d90780", "operator": {"name": "Equals", "value": "Equals", "shortDisplay": "="}, "value": "3"}, {"id": "fcfc6e3f-eac4-4705-9f80-5977f8617b07", "operator": {"name": "Is greater than", "value": "GreaterThan", "shortDisplay": ">"}, "value": "3"}]}, "abd912f4-b9bd-45e6-9cf1-56a38687a007": {"position": {"x": 3662.4, "y": 2208.8}, "parameters": {"Attributes": {"Flag_Flow_NextActionType": {"useDynamic": true}, "Flag_Flow_NextActionValue": {"useDynamic": true}, "Flag_Flow_NextActionPrompt": {"useDynamic": true}}}, "dynamicParams": ["Flag_Flow_NextActionType", "Flag_Flow_NextActionValue", "Flag_Flow_NextActionPrompt"]}, "be6f3a54-4792-4f18-ae96-94592e0a89e3": {"position": {"x": 3144.8, "y": 1259.2}, "conditions": [], "conditionMetadata": [{"id": "57ce8f75-a70a-4e4b-9ddf-b1ca495e8607", "operator": {"name": "Equals", "value": "Equals", "shortDisplay": "="}, "value": "steeringmenu"}, {"id": "3eee9c45-315c-48a1-af0d-7cc49e704914", "operator": {"name": "Equals", "value": "Equals", "shortDisplay": "="}, "value": "flow"}, {"id": "ca84eb3b-c00a-4dc1-b063-461d59e3ae39", "operator": {"name": "Equals", "value": "Equals", "shortDisplay": "="}, "value": "disconnect"}, {"id": "38762f67-1971-49c1-952a-7760b1ab46c3", "operator": {"name": "Equals", "value": "Equals", "shortDisplay": "="}, "value": "external"}, {"id": "fefed57e-85ef-45ec-8cff-93a74c8a40ef", "operator": {"name": "Equals", "value": "Equals", "shortDisplay": "="}, "value": "queue"}]}, "462603a2-4628-41db-ac59-5eb7a4d93c40": {"position": {"x": 3389.6, "y": 2068}, "conditions": [], "conditionMetadata": [{"id": "56e63d50-8f68-4cca-ab68-62326b66e86e", "operator": {"name": "Is greater or equal", "value": "GreaterThanOrEqualTo", "shortDisplay": ">="}, "value": "$.External.Flag_SteeringMenu_Retries"}]}, "c1dce7ac-66b9-4c71-80b5-57155c598f93": {"position": {"x": 667.2, "y": -215.2}}, "1dc1e306-0f37-4337-aae9-accdfb7aa531": {"position": {"x": 925.6, "y": -200}, "parameters": {"ContactFlowId": {"displayName": "CloudInteract_Core_PreQueue"}}, "ContactFlow": {"text": "CloudInteract_Core_PreQueue"}}, "d07410f9-48f7-4d0a-aab3-84aa49ca8ee8": {"position": {"x": 1182.4, "y": -185.6}}}, "Annotations": []}, "Actions": [{"Parameters": {"ComparisonValue": "$.StoredCustomerInput"}, "Identifier": "e6e107fd-a6a7-4e1e-a4a8-30b1914f0841", "Type": "Compare", "Transitions": {"NextAction": "f577a044-91f9-46c4-b054-533b9a7eea82", "Conditions": [{"NextAction": "c215b098-b596-4205-920f-50b755846cd6", "Condition": {"Operator": "Equals", "Operands": ["1"]}}, {"NextAction": "b95e8e55-150f-4408-970a-33db87c14ff8", "Condition": {"Operator": "Equals", "Operands": ["2"]}}, {"NextAction": "0d2bf40f-2b0e-430d-86a7-67ebac686ed3", "Condition": {"Operator": "Equals", "Operands": ["3"]}}, {"NextAction": "64d13dfd-ca92-417c-822c-3718dfccf85b", "Condition": {"Operator": "Equals", "Operands": ["4"]}}, {"NextAction": "ed74aa68-2e77-4611-878a-f9c1d2f75f8c", "Condition": {"Operator": "Equals", "Operands": ["5"]}}, {"NextAction": "0e14a2e8-3be3-4d55-a939-61ebe18b4eba", "Condition": {"Operator": "Equals", "Operands": ["6"]}}, {"NextAction": "45e54fa9-5c7d-4cf2-82cd-fca6da9b87c1", "Condition": {"Operator": "Equals", "Operands": ["7"]}}, {"NextAction": "328d2284-2a72-4dcd-9875-bca56cd3c09f", "Condition": {"Operator": "Equals", "Operands": ["8"]}}, {"NextAction": "54476530-6140-4407-88d9-7c6bb1994e95", "Condition": {"Operator": "Equals", "Operands": ["9"]}}, {"NextAction": "4b723861-f8d2-463a-af6f-2508ef661b64", "Condition": {"Operator": "Equals", "Operands": ["0"]}}, {"NextAction": "2f512687-f8e2-459b-90d3-4e43bef0b569", "Condition": {"Operator": "Equals", "Operands": ["*"]}}, {"NextAction": "0e1db850-c245-4bda-a95b-35b6b7ba477d", "Condition": {"Operator": "Equals", "Operands": ["#"]}}, {"NextAction": "f577a044-91f9-46c4-b054-533b9a7eea82", "Condition": {"Operator": "Equals", "Operands": ["Timeout"]}}], "Errors": [{"NextAction": "f577a044-91f9-46c4-b054-533b9a7eea82", "ErrorType": "NoMatchingCondition"}]}}, {"Parameters": {"Attributes": {"Flag_Flow_NextActionType": "$.External.Flag_SteeringMenu_NextActionType_1", "Flag_Flow_NextActionValue": "$.External.Flag_SteeringMenu_NextActionValue_1", "Flag_Flow_NextActionPrompt": "$.External.Flag_SteeringMenu_NextActionPrompt_1"}, "TargetContact": "Current"}, "Identifier": "c215b098-b596-4205-920f-50b755846cd6", "Type": "UpdateContactAttributes", "Transitions": {"NextAction": "Check for Option Prompt", "Errors": [{"NextAction": "Check for Option Prompt", "ErrorType": "NoMatchingError"}]}}, {"Parameters": {"Attributes": {"Flag_Flow_NextActionType": "$.External.Flag_SteeringMenu_NextActionType_2", "Flag_Flow_NextActionValue": "$.External.Flag_SteeringMenu_NextActionValue_2", "Flag_Flow_NextActionPrompt": "$.External.Flag_SteeringMenu_NextActionPrompt_2"}, "TargetContact": "Current"}, "Identifier": "b95e8e55-150f-4408-970a-33db87c14ff8", "Type": "UpdateContactAttributes", "Transitions": {"NextAction": "Check for Option Prompt", "Errors": [{"NextAction": "Check for Option Prompt", "ErrorType": "NoMatchingError"}]}}, {"Parameters": {"Attributes": {"Flag_Flow_NextActionType": "$.External.Flag_SteeringMenu_NextActionType_3", "Flag_Flow_NextActionValue": "$.External..Flag_SteeringMenu_NextActionValue_3", "Flag_Flow_NextActionPrompt": "$.External.Flag_SteeringMenu_NextActionPrompt_3"}, "TargetContact": "Current"}, "Identifier": "0d2bf40f-2b0e-430d-86a7-67ebac686ed3", "Type": "UpdateContactAttributes", "Transitions": {"NextAction": "Check for Option Prompt", "Errors": [{"NextAction": "Check for Option Prompt", "ErrorType": "NoMatchingError"}]}}, {"Parameters": {"Attributes": {"Flag_Flow_NextActionType": "$.External.Flag_SteeringMenu_NextActionType_4", "Flag_Flow_NextActionValue": "$.External.Flag_SteeringMenu_NextActionValue_4", "Flag_Flow_NextActionPrompt": "$.External.Flag_SteeringMenu_NextActionPrompt_4"}, "TargetContact": "Current"}, "Identifier": "64d13dfd-ca92-417c-822c-3718dfccf85b", "Type": "UpdateContactAttributes", "Transitions": {"NextAction": "Check for Option Prompt", "Errors": [{"NextAction": "Check for Option Prompt", "ErrorType": "NoMatchingError"}]}}, {"Parameters": {"Attributes": {"Flag_Flow_NextActionType": "$.External.Flag_SteeringMenu_NextActionType_5", "Flag_Flow_NextActionValue": "$.External.Flag_SteeringMenu_NextActionValue_5", "Flag_Flow_NextActionPrompt": "$.External.Flag_SteeringMenu_NextActionPrompt_5"}, "TargetContact": "Current"}, "Identifier": "ed74aa68-2e77-4611-878a-f9c1d2f75f8c", "Type": "UpdateContactAttributes", "Transitions": {"NextAction": "Check for Option Prompt", "Errors": [{"NextAction": "Check for Option Prompt", "ErrorType": "NoMatchingError"}]}}, {"Parameters": {"Attributes": {"Flag_Flow_NextActionType": "$.External.Flag_SteeringMenu_NextActionType_6", "Flag_Flow_NextActionValue": "$.External.Flag_SteeringMenu_NextActionValue_6", "Flag_Flow_NextActionPrompt": "$.External.Flag_SteeringMenu_NextActionPrompt_6"}, "TargetContact": "Current"}, "Identifier": "0e14a2e8-3be3-4d55-a939-61ebe18b4eba", "Type": "UpdateContactAttributes", "Transitions": {"NextAction": "Check for Option Prompt", "Errors": [{"NextAction": "Check for Option Prompt", "ErrorType": "NoMatchingError"}]}}, {"Parameters": {"Attributes": {"Flag_Flow_NextActionType": "$.External.Flag_SteeringMenu_NextActionType_7", "Flag_Flow_NextActionValue": "$.External.Flag_SteeringMenu_NextActionValue_7", "Flag_Flow_NextActionPrompt": "$.External.Flag_SteeringMenu_NextActionPrompt_7"}, "TargetContact": "Current"}, "Identifier": "45e54fa9-5c7d-4cf2-82cd-fca6da9b87c1", "Type": "UpdateContactAttributes", "Transitions": {"NextAction": "Check for Option Prompt", "Errors": [{"NextAction": "Check for Option Prompt", "ErrorType": "NoMatchingError"}]}}, {"Parameters": {"Attributes": {"Flag_Flow_NextActionType": "$.External.Flag_SteeringMenu_NextActionType_8", "Flag_Flow_NextActionValue": "$.External.Flag_SteeringMenu_NextActionValue_8", "Flag_Flow_NextActionPrompt": "$.External.Flag_SteeringMenu_NextActionPrompt_8"}, "TargetContact": "Current"}, "Identifier": "328d2284-2a72-4dcd-9875-bca56cd3c09f", "Type": "UpdateContactAttributes", "Transitions": {"NextAction": "Check for Option Prompt", "Errors": [{"NextAction": "Check for Option Prompt", "ErrorType": "NoMatchingError"}]}}, {"Parameters": {"Attributes": {"Flag_Flow_NextActionType": "$.External.Flag_SteeringMenu_NextActionType_9", "Flag_Flow_NextActionValue": "$.External.Flag_SteeringMenu_NextActionValue_9", "Flag_Flow_NextActionPrompt": "$.External.Flag_SteeringMenu_NextActionPrompt_9"}, "TargetContact": "Current"}, "Identifier": "54476530-6140-4407-88d9-7c6bb1994e95", "Type": "UpdateContactAttributes", "Transitions": {"NextAction": "Check for Option Prompt", "Errors": [{"NextAction": "Check for Option Prompt", "ErrorType": "NoMatchingError"}]}}, {"Parameters": {"Attributes": {"Flag_Flow_NextActionType": "$.External.Flag_SteeringMenu_NextActionType_0", "Flag_Flow_NextActionValue": "$.External.Flag_SteeringMenu_NextActionValue_0", "Flag_Flow_NextActionPrompt": "$.External.Flag_SteeringMenu_NextActionPrompt_0"}, "TargetContact": "Current"}, "Identifier": "4b723861-f8d2-463a-af6f-2508ef661b64", "Type": "UpdateContactAttributes", "Transitions": {"NextAction": "Check for Option Prompt", "Errors": [{"NextAction": "Check for Option Prompt", "ErrorType": "NoMatchingError"}]}}, {"Parameters": {"Attributes": {"Flag_Flow_NextActionType": "$.External.Flag_SteeringMenu_NextActionType_Star", "Flag_Flow_NextActionValue": "$.External.Flag_SteeringMenu_NextActionValue_Star", "Flag_Flow_NextActionPrompt": "$.External.Flag_SteeringMenu_NextActionPrompt_Star"}, "TargetContact": "Current"}, "Identifier": "2f512687-f8e2-459b-90d3-4e43bef0b569", "Type": "UpdateContactAttributes", "Transitions": {"NextAction": "Check for Option Prompt", "Errors": [{"NextAction": "Check for Option Prompt", "ErrorType": "NoMatchingError"}]}}, {"Parameters": {"Attributes": {"Flag_Flow_NextActionType": "$.External.Flag_SteeringMenu_NextActionType_Hash", "Flag_Flow_NextActionValue": "$.External.Flag_SteeringMenu_NextActionValue_Hash", "Flag_Flow_NextActionPrompt": "$.External.Flag_SteeringMenu_NextActionPrompt_Hash"}, "TargetContact": "Current"}, "Identifier": "0e1db850-c245-4bda-a95b-35b6b7ba477d", "Type": "UpdateContactAttributes", "Transitions": {"NextAction": "Check for Option Prompt", "Errors": [{"NextAction": "Check for Option Prompt", "ErrorType": "NoMatchingError"}]}}, {"Parameters": {"Attributes": {"Flag_Flow_NextActionType": "$.External.Flag_SteeringMenu_NextActionType_Timeout", "Flag_Flow_NextActionValue": "$.External.Flag_SteeringMenu_NextActionValue_Timeout", "Flag_Flow_NextActionPrompt": "$.External.Flag_SteeringMenu_NextActionPrompt_Timeout"}, "TargetContact": "Current"}, "Identifier": "f577a044-91f9-46c4-b054-533b9a7eea82", "Type": "UpdateContactAttributes", "Transitions": {"NextAction": "Check for Option Prompt", "Errors": [{"NextAction": "Check for Option Prompt", "ErrorType": "NoMatchingError"}]}}, {"Parameters": {"StoreInput": "True", "InputTimeLimitSeconds": "5", "PromptId": "$.External.Prompt_SteeringMenu_MenuOptions", "DTMFConfiguration": {"DisableCancelKey": "False"}, "InputValidation": {"CustomValidation": {"MaximumLength": "1"}}}, "Identifier": "d9456743-31f0-4b29-955c-d16a8c2adc1d", "Type": "GetParticipantInput", "Transitions": {"NextAction": "e6e107fd-a6a7-4e1e-a4a8-30b1914f0841", "Errors": [{"NextAction": "dda47293-7b7a-4c1a-8990-9c946e510955", "ErrorType": "NoMatchingError"}]}}, {"Parameters": {"StoreInput": "True", "InputTimeLimitSeconds": "5", "Media": {"Uri": "$.External.Prompt_SteeringMenu_MenuOptions", "SourceType": "S3", "MediaType": "Audio"}, "DTMFConfiguration": {"DisableCancelKey": "False"}, "InputValidation": {"CustomValidation": {"MaximumLength": "1"}}}, "Identifier": "e121513d-3255-4093-960a-3e00db5a0312", "Type": "GetParticipantInput", "Transitions": {"NextAction": "e6e107fd-a6a7-4e1e-a4a8-30b1914f0841", "Errors": [{"NextAction": "dda47293-7b7a-4c1a-8990-9c946e510955", "ErrorType": "NoMatchingError"}]}}, {"Parameters": {"StoreInput": "True", "InputTimeLimitSeconds": "5", "SSML": "$.External.Prompt_SteeringMenu_MenuOptions", "DTMFConfiguration": {"DisableCancelKey": "False"}, "InputValidation": {"CustomValidation": {"MaximumLength": "1"}}}, "Identifier": "a7cb0aad-e1c8-4da4-ba4d-de9052c0273b", "Type": "GetParticipantInput", "Transitions": {"NextAction": "e6e107fd-a6a7-4e1e-a4a8-30b1914f0841", "Errors": [{"NextAction": "dda47293-7b7a-4c1a-8990-9c946e510955", "ErrorType": "NoMatchingError"}]}}, {"Parameters": {"StoreInput": "True", "InputTimeLimitSeconds": "5", "Text": "$.External.Prompt_SteeringMenu_MenuOptions", "DTMFConfiguration": {"DisableCancelKey": "False"}, "InputValidation": {"CustomValidation": {"MaximumLength": "1"}}}, "Identifier": "45e32a72-5d88-4b11-9d3a-8003bdc0c5be", "Type": "GetParticipantInput", "Transitions": {"NextAction": "e6e107fd-a6a7-4e1e-a4a8-30b1914f0841", "Errors": [{"NextAction": "dda47293-7b7a-4c1a-8990-9c946e510955", "ErrorType": "NoMatchingError"}]}}, {"Parameters": {"Attributes": {"Flag_Flow_Retries": "1"}, "TargetContact": "Current"}, "Identifier": "22648677-d617-4501-b265-8c85dbfb646d", "Type": "UpdateContactAttributes", "Transitions": {"NextAction": "dfb7b765-4e39-44b4-b935-309bc474fd98", "Errors": [{"NextAction": "dfb7b765-4e39-44b4-b935-309bc474fd98", "ErrorType": "NoMatchingError"}]}}, {"Parameters": {"Attributes": {"Flag_Flow_Retries": "4"}, "TargetContact": "Current"}, "Identifier": "5b43481f-3e78-4a2c-b52b-893a79d1c38f", "Type": "UpdateContactAttributes", "Transitions": {"NextAction": "dfb7b765-4e39-44b4-b935-309bc474fd98", "Errors": [{"NextAction": "dfb7b765-4e39-44b4-b935-309bc474fd98", "ErrorType": "NoMatchingError"}]}}, {"Parameters": {"Attributes": {"Flag_Flow_Retries": "3"}, "TargetContact": "Current"}, "Identifier": "9978fd36-4742-4321-9b8d-09d9df6d2966", "Type": "UpdateContactAttributes", "Transitions": {"NextAction": "dfb7b765-4e39-44b4-b935-309bc474fd98", "Errors": [{"NextAction": "dfb7b765-4e39-44b4-b935-309bc474fd98", "ErrorType": "NoMatchingError"}]}}, {"Parameters": {"Attributes": {"Flag_Flow_Retries": "2"}, "TargetContact": "Current"}, "Identifier": "4c8da866-591e-4d6e-9243-991d1e3dfaa4", "Type": "UpdateContactAttributes", "Transitions": {"NextAction": "dfb7b765-4e39-44b4-b935-309bc474fd98", "Errors": [{"NextAction": "dfb7b765-4e39-44b4-b935-309bc474fd98", "ErrorType": "NoMatchingError"}]}}, {"Parameters": {"ComparisonValue": "$.External.Prompt_SteeringMenu_PreMenuOptions"}, "Identifier": "Check for Pre-Menu Prompt", "Type": "Compare", "Transitions": {"NextAction": "ed5db109-f3bc-48b5-bd18-c2cd37eca391", "Conditions": [{"NextAction": "dfb7b765-4e39-44b4-b935-309bc474fd98", "Condition": {"Operator": "Equals", "Operands": ["$.Attributes.Null"]}}], "Errors": [{"NextAction": "ed5db109-f3bc-48b5-bd18-c2cd37eca391", "ErrorType": "NoMatchingCondition"}]}}, {"Parameters": {"LambdaFunctionARN": "${iLambdaLambdafunction}", "InvocationTimeLimitSeconds": "8", "LambdaInvocationAttributes": {"Primary_Key": "$.Attributes.Flag_Flow_SteeringMenu", "Resource_Type": "SteeringMenu"}, "ResponseValidation": {"ResponseType": "STRING_MAP"}}, "Identifier": "Get Menu Config", "Type": "InvokeLambdaFunction", "Transitions": {"NextAction": "Check for Pre-Menu Prompt", "Errors": [{"NextAction": "c1dce7ac-66b9-4c71-80b5-57155c598f93", "ErrorType": "NoMatchingError"}]}}, {"Parameters": {"ComparisonValue": "$.External.Prompt_SteeringMenu_MenuOptions"}, "Identifier": "dfb7b765-4e39-44b4-b935-309bc474fd98", "Type": "Compare", "Transitions": {"NextAction": "45e32a72-5d88-4b11-9d3a-8003bdc0c5be", "Conditions": [{"NextAction": "f0c22056-c5fa-43a4-97be-5aa104b485c9", "Condition": {"Operator": "Equals", "Operands": ["$.Attributes.Null"]}}, {"NextAction": "d9456743-31f0-4b29-955c-d16a8c2adc1d", "Condition": {"Operator": "TextStartsWith", "Operands": ["arn"]}}, {"NextAction": "e121513d-3255-4093-960a-3e00db5a0312", "Condition": {"Operator": "TextStartsWith", "Operands": ["http"]}}, {"NextAction": "a7cb0aad-e1c8-4da4-ba4d-de9052c0273b", "Condition": {"Operator": "TextStartsWith", "Operands": ["<speak>"]}}], "Errors": [{"NextAction": "45e32a72-5d88-4b11-9d3a-8003bdc0c5be", "ErrorType": "NoMatchingCondition"}]}}, {"Parameters": {"Attributes": {"Prompt_Flow_TempModuleAttribute": "$.External.Prompt_SteeringMenu_PreMenuOptions"}, "TargetContact": "Current"}, "Identifier": "ed5db109-f3bc-48b5-bd18-c2cd37eca391", "Type": "UpdateContactAttributes", "Transitions": {"NextAction": "Play Pre-Menu Prompt", "Errors": [{"NextAction": "dfb7b765-4e39-44b4-b935-309bc474fd98", "ErrorType": "NoMatchingError"}]}}, {"Parameters": {"FlowModuleId": "${iConnectContactFlowModuleCloudInteractCorePlayPrompt}"}, "Identifier": "Play Pre-Menu Prompt", "Type": "InvokeFlowModule", "Transitions": {"NextAction": "dfb7b765-4e39-44b4-b935-309bc474fd98", "Errors": [{"NextAction": "dfb7b765-4e39-44b4-b935-309bc474fd98", "ErrorType": "NoMatchingError"}]}}, {"Parameters": {}, "Identifier": "1d4eb336-0896-439e-91c9-4e79c3ead591", "Type": "DisconnectParticipant", "Transitions": {}}, {"Parameters": {"Attributes": {"Log_WARN": "Prompt_SteeringMenu_MenuOptions was empty, transfering to queue"}, "TargetContact": "Current"}, "Identifier": "f0c22056-c5fa-43a4-97be-5aa104b485c9", "Type": "UpdateContactAttributes", "Transitions": {"NextAction": "7bfcd4ca-5b92-48dd-9199-bbd7ad906c38", "Errors": [{"NextAction": "7bfcd4ca-5b92-48dd-9199-bbd7ad906c38", "ErrorType": "NoMatchingError"}]}}, {"Parameters": {"ContactFlowId": "${iConnectContactflowCloudInteractCorePreQueue}"}, "Identifier": "7bfcd4ca-5b92-48dd-9199-bbd7ad906c38", "Type": "TransferToFlow", "Transitions": {"NextAction": "1d4eb336-0896-439e-91c9-4e79c3ead591", "Errors": [{"NextAction": "1d4eb336-0896-439e-91c9-4e79c3ead591", "ErrorType": "NoMatchingError"}]}}, {"Parameters": {}, "Identifier": "2ae32127-0a36-4ac4-9c41-50c93d4ff941", "Type": "DisconnectParticipant", "Transitions": {}}, {"Parameters": {"Attributes": {"Log_ERROR": "Enable to play Steering Menu, transfering to Prequeue"}, "TargetContact": "Current"}, "Identifier": "dda47293-7b7a-4c1a-8990-9c946e510955", "Type": "UpdateContactAttributes", "Transitions": {"NextAction": "3f10a16c-9d1c-4bc6-ab45-f6382f2aca52", "Errors": [{"NextAction": "3f10a16c-9d1c-4bc6-ab45-f6382f2aca52", "ErrorType": "NoMatchingError"}]}}, {"Parameters": {"ContactFlowId": "${iConnectContactflowCloudInteractCorePreQueue}"}, "Identifier": "3f10a16c-9d1c-4bc6-ab45-f6382f2aca52", "Type": "TransferToFlow", "Transitions": {"NextAction": "2ae32127-0a36-4ac4-9c41-50c93d4ff941", "Errors": [{"NextAction": "2ae32127-0a36-4ac4-9c41-50c93d4ff941", "ErrorType": "NoMatchingError"}]}}, {"Parameters": {"Attributes": {"Prompt_Flow_TempModuleAttribute": "$.Attributes.Flag_Flow_NextActionValue"}, "TargetContact": "Current"}, "Identifier": "daa801f4-34d0-46e5-9ea6-95da5df376ca", "Type": "UpdateContactAttributes", "Transitions": {"NextAction": "Play Disconnect Message", "Errors": [{"NextAction": "e8d4c563-c8b9-4d83-ad72-ce879c750511", "ErrorType": "NoMatchingError"}]}}, {"Parameters": {}, "Identifier": "e8d4c563-c8b9-4d83-ad72-ce879c750511", "Type": "DisconnectParticipant", "Transitions": {}}, {"Parameters": {"FlowModuleId": "${iConnectContactFlowModuleCloudInteractCorePlayPrompt}"}, "Identifier": "Play Disconnect Message", "Type": "InvokeFlowModule", "Transitions": {"NextAction": "e8d4c563-c8b9-4d83-ad72-ce879c750511", "Errors": [{"NextAction": "e8d4c563-c8b9-4d83-ad72-ce879c750511", "ErrorType": "NoMatchingError"}]}}, {"Parameters": {"ComparisonValue": "$.Attributes.Flag_Flow_NextActionPrompt"}, "Identifier": "Check for Option Prompt", "Type": "Compare", "Transitions": {"NextAction": "7df3c308-1857-4d96-b744-078fcc174305", "Conditions": [{"NextAction": "be6f3a54-4792-4f18-ae96-94592e0a89e3", "Condition": {"Operator": "Equals", "Operands": ["$.Attributes.Null"]}}], "Errors": [{"NextAction": "7df3c308-1857-4d96-b744-078fcc174305", "ErrorType": "NoMatchingCondition"}]}}, {"Parameters": {"Attributes": {"Prompt_Flow_TempModuleAttribute": "$.Attributes.Flag_Flow_NextActionPrompt"}, "TargetContact": "Current"}, "Identifier": "7df3c308-1857-4d96-b744-078fcc174305", "Type": "UpdateContactAttributes", "Transitions": {"NextAction": "Play Option Prompt", "Errors": [{"NextAction": "be6f3a54-4792-4f18-ae96-94592e0a89e3", "ErrorType": "NoMatchingError"}]}}, {"Parameters": {"FlowModuleId": "${iConnectContactFlowModuleCloudInteractCorePlayPrompt}"}, "Identifier": "Play Option Prompt", "Type": "InvokeFlowModule", "Transitions": {"NextAction": "be6f3a54-4792-4f18-ae96-94592e0a89e3", "Errors": [{"NextAction": "be6f3a54-4792-4f18-ae96-94592e0a89e3", "ErrorType": "NoMatchingError"}]}}, {"Parameters": {"ComparisonValue": "$.Attributes.Flag_Flow_NextActionValue"}, "Identifier": "Check Disconnect Message", "Type": "Compare", "Transitions": {"NextAction": "daa801f4-34d0-46e5-9ea6-95da5df376ca", "Conditions": [{"NextAction": "e8d4c563-c8b9-4d83-ad72-ce879c750511", "Condition": {"Operator": "Equals", "Operands": ["$.Attributes.Null"]}}], "Errors": [{"NextAction": "daa801f4-34d0-46e5-9ea6-95da5df376ca", "ErrorType": "NoMatchingCondition"}]}}, {"Parameters": {"ThirdPartyPhoneNumber": "$.Attributes.Flag_Flow_NextActionValue", "ThirdPartyConnectionTimeLimitSeconds": "30", "ContinueFlowExecution": "False"}, "Identifier": "1cb69288-ff1c-43ed-bad0-92ba994eefba", "Type": "TransferParticipantToThirdParty", "Transitions": {"NextAction": "ccd29872-ba23-4631-8ad9-1ca96f018bee", "Errors": [{"NextAction": "ccd29872-ba23-4631-8ad9-1ca96f018bee", "ErrorType": "NoMatchingError"}]}}, {"Parameters": {"ComparisonValue": "$.CustomerEndpoint.Address"}, "Identifier": "ecd7f937-a1cd-4036-88e4-f03ebed1ef9f", "Type": "Compare", "Transitions": {"NextAction": "ccd29872-ba23-4631-8ad9-1ca96f018bee", "Conditions": [{"NextAction": "1cb69288-ff1c-43ed-bad0-92ba994eefba", "Condition": {"Operator": "TextStartsWith", "Operands": ["+"]}}], "Errors": [{"NextAction": "ccd29872-ba23-4631-8ad9-1ca96f018bee", "ErrorType": "NoMatchingCondition"}]}}, {"Parameters": {"ThirdPartyPhoneNumber": "$.Attributes.Flag_Flow_NextActionValue", "ThirdPartyConnectionTimeLimitSeconds": "30", "ContinueFlowExecution": "False", "CallerId": {"Number": "$.Queue.OutboundCallerId.Address"}}, "Identifier": "ccd29872-ba23-4631-8ad9-1ca96f018bee", "Type": "TransferParticipantToThirdParty", "Transitions": {"NextAction": "f94c8894-7539-4788-8815-4ac1af2f2367", "Errors": [{"NextAction": "f94c8894-7539-4788-8815-4ac1af2f2367", "ErrorType": "NoMatchingError"}]}}, {"Parameters": {"LoopCount": "1"}, "Identifier": "9e6e9c1c-7164-490d-9456-90629450a5ff", "Type": "Loop", "Transitions": {"NextAction": "772479c1-192d-440a-a575-5c1cb243a854", "Conditions": [{"NextAction": "be6f3a54-4792-4f18-ae96-94592e0a89e3", "Condition": {"Operator": "Equals", "Operands": ["ContinueLooping"]}}, {"NextAction": "772479c1-192d-440a-a575-5c1cb243a854", "Condition": {"Operator": "Equals", "Operands": ["DoneLooping"]}}]}}, {"Parameters": {"ContactFlowId": "$.External. Flag_Flow_NextActionValue"}, "Identifier": "2ab6c43b-7b04-483a-83a2-87bcc3a3be7a", "Type": "TransferToFlow", "Transitions": {"NextAction": "b501e678-548b-4279-92bf-666f85b5f58f", "Errors": [{"NextAction": "b501e678-548b-4279-92bf-666f85b5f58f", "ErrorType": "NoMatchingError"}]}}, {"Parameters": {"Attributes": {"Flag_Flow_Retries": "0", "Flag_Flow_NextActionType": "$.Attributes.Null", "Flag_Flow_NextActionValue": "$.Attributes.Null", "Flag_Flow_NextActionPrompt": "$.Attributes.Null"}, "TargetContact": "Current"}, "Identifier": "0a2bf7db-6ea8-4e4d-9e5b-3f5ba8d6777f", "Type": "UpdateContactAttributes", "Transitions": {"NextAction": "Get Menu Config", "Errors": [{"NextAction": "Get Menu Config", "ErrorType": "NoMatchingError"}]}}, {"Parameters": {"Attributes": {"Flag_Flow_SteeringMenu": "$.Attributes.Flag_Flow_NextActionValue"}, "TargetContact": "Current"}, "Identifier": "8c4d879d-5d70-4abe-8b71-77677a9681db", "Type": "UpdateContactAttributes", "Transitions": {"NextAction": "0a2bf7db-6ea8-4e4d-9e5b-3f5ba8d6777f", "Errors": [{"NextAction": "0a2bf7db-6ea8-4e4d-9e5b-3f5ba8d6777f", "ErrorType": "NoMatchingError"}]}}, {"Parameters": {"QueueId": "$.External. Flag_Flow_NextActionValue"}, "Identifier": "f0516708-6f9b-402b-9799-9c471d459124", "Type": "UpdateContactTargetQueue", "Transitions": {"NextAction": "252ac0bb-137a-4eb5-aade-a99d1ddc9188", "Errors": [{"NextAction": "4860dc19-b643-45b6-a884-fad205b67054", "ErrorType": "NoMatchingError"}]}}, {"Parameters": {"FlowAttributes": {"Log_WARN": {"Value": "Unable to Set Working Queue from DeliveryId Config as Next Action."}}}, "Identifier": "4860dc19-b643-45b6-a884-fad205b67054", "Type": "UpdateFlowAttributes", "Transitions": {"NextAction": "252ac0bb-137a-4eb5-aade-a99d1ddc9188", "Errors": [{"NextAction": "252ac0bb-137a-4eb5-aade-a99d1ddc9188", "ErrorType": "NoMatchingError"}]}}, {"Parameters": {"FlowAttributes": {"Log_WARN": {"Value": "Unable to Dial out to external number $.External.Flag_DeliveryId_NextActionValue"}}}, "Identifier": "f94c8894-7539-4788-8815-4ac1af2f2367", "Type": "UpdateFlowAttributes", "Transitions": {"NextAction": "252ac0bb-137a-4eb5-aade-a99d1ddc9188", "Errors": [{"NextAction": "252ac0bb-137a-4eb5-aade-a99d1ddc9188", "ErrorType": "NoMatchingError"}]}}, {"Parameters": {"FlowAttributes": {"Log_WARN": {"Value": "No Valid Default Option found"}}}, "Identifier": "772479c1-192d-440a-a575-5c1cb243a854", "Type": "UpdateFlowAttributes", "Transitions": {"NextAction": "252ac0bb-137a-4eb5-aade-a99d1ddc9188", "Errors": [{"NextAction": "252ac0bb-137a-4eb5-aade-a99d1ddc9188", "ErrorType": "NoMatchingError"}]}}, {"Parameters": {"FlowAttributes": {"Log_ERROR": {"Value": "Unable to goto Flow from DeliveryId Config as Next Action."}}}, "Identifier": "b501e678-548b-4279-92bf-666f85b5f58f", "Type": "UpdateFlowAttributes", "Transitions": {"NextAction": "252ac0bb-137a-4eb5-aade-a99d1ddc9188", "Errors": [{"NextAction": "252ac0bb-137a-4eb5-aade-a99d1ddc9188", "ErrorType": "NoMatchingError"}]}}, {"Parameters": {"ContactFlowId": "${iConnectContactflowCloudInteractCorePreQueue}"}, "Identifier": "252ac0bb-137a-4eb5-aade-a99d1ddc9188", "Type": "TransferToFlow", "Transitions": {"NextAction": "d6e5da29-a8da-438a-97ae-4734f2d74abd", "Errors": [{"NextAction": "d6e5da29-a8da-438a-97ae-4734f2d74abd", "ErrorType": "NoMatchingError"}]}}, {"Parameters": {}, "Identifier": "d6e5da29-a8da-438a-97ae-4734f2d74abd", "Type": "DisconnectParticipant", "Transitions": {}}, {"Parameters": {"ComparisonValue": "$.Attributes.Flag_Flow_Retries"}, "Identifier": "17332d5c-8a8e-47c9-bea9-b1e47711e343", "Type": "Compare", "Transitions": {"NextAction": "22648677-d617-4501-b265-8c85dbfb646d", "Conditions": [{"NextAction": "4c8da866-591e-4d6e-9243-991d1e3dfaa4", "Condition": {"Operator": "Equals", "Operands": ["1"]}}, {"NextAction": "9978fd36-4742-4321-9b8d-09d9df6d2966", "Condition": {"Operator": "Equals", "Operands": ["2"]}}, {"NextAction": "5b43481f-3e78-4a2c-b52b-893a79d1c38f", "Condition": {"Operator": "Equals", "Operands": ["3"]}}, {"NextAction": "abd912f4-b9bd-45e6-9cf1-56a38687a007", "Condition": {"Operator": "NumberGreaterThan", "Operands": ["3"]}}], "Errors": [{"NextAction": "22648677-d617-4501-b265-8c85dbfb646d", "ErrorType": "NoMatchingCondition"}]}}, {"Parameters": {"Attributes": {"Flag_Flow_NextActionType": "$.External.Flag_SteeringMenu_NextActionType_Default", "Flag_Flow_NextActionValue": "$.External.Flag_SteeringMenu_NextActionValue_Default", "Flag_Flow_NextActionPrompt": "$.External.Flag_SteeringMenu_NextActionPrompt_Default"}, "TargetContact": "Current"}, "Identifier": "abd912f4-b9bd-45e6-9cf1-56a38687a007", "Type": "UpdateContactAttributes", "Transitions": {"NextAction": "9e6e9c1c-7164-490d-9456-90629450a5ff", "Errors": [{"NextAction": "9e6e9c1c-7164-490d-9456-90629450a5ff", "ErrorType": "NoMatchingError"}]}}, {"Parameters": {"ComparisonValue": "$.Attributes.Flag_Flow_NextActionType"}, "Identifier": "be6f3a54-4792-4f18-ae96-94592e0a89e3", "Type": "Compare", "Transitions": {"NextAction": "462603a2-4628-41db-ac59-5eb7a4d93c40", "Conditions": [{"NextAction": "8c4d879d-5d70-4abe-8b71-77677a9681db", "Condition": {"Operator": "Equals", "Operands": ["steeringmenu"]}}, {"NextAction": "2ab6c43b-7b04-483a-83a2-87bcc3a3be7a", "Condition": {"Operator": "Equals", "Operands": ["flow"]}}, {"NextAction": "Check Disconnect Message", "Condition": {"Operator": "Equals", "Operands": ["disconnect"]}}, {"NextAction": "ecd7f937-a1cd-4036-88e4-f03ebed1ef9f", "Condition": {"Operator": "Equals", "Operands": ["external"]}}, {"NextAction": "f0516708-6f9b-402b-9799-9c471d459124", "Condition": {"Operator": "Equals", "Operands": ["queue"]}}], "Errors": [{"NextAction": "462603a2-4628-41db-ac59-5eb7a4d93c40", "ErrorType": "NoMatchingCondition"}]}}, {"Parameters": {"ComparisonValue": "$.Attributes.Flag_Flow_Retries"}, "Identifier": "462603a2-4628-41db-ac59-5eb7a4d93c40", "Type": "Compare", "Transitions": {"NextAction": "17332d5c-8a8e-47c9-bea9-b1e47711e343", "Conditions": [{"NextAction": "abd912f4-b9bd-45e6-9cf1-56a38687a007", "Condition": {"Operator": "NumberGreaterOrEqualTo", "Operands": ["$.External.Flag_SteeringMenu_Retries"]}}], "Errors": [{"NextAction": "17332d5c-8a8e-47c9-bea9-b1e47711e343", "ErrorType": "NoMatchingCondition"}]}}, {"Parameters": {"FlowAttributes": {"Log_ERROR": {"Value": "Unable to get Steering Menu using: $.Attributes.Flag_Flow_SteeringMenu"}}}, "Identifier": "c1dce7ac-66b9-4c71-80b5-57155c598f93", "Type": "UpdateFlowAttributes", "Transitions": {"NextAction": "1dc1e306-0f37-4337-aae9-accdfb7aa531", "Errors": [{"NextAction": "1dc1e306-0f37-4337-aae9-accdfb7aa531", "ErrorType": "NoMatchingError"}]}}, {"Parameters": {"ContactFlowId": "${iConnectContactflowCloudInteractCorePreQueue}"}, "Identifier": "1dc1e306-0f37-4337-aae9-accdfb7aa531", "Type": "TransferToFlow", "Transitions": {"NextAction": "d07410f9-48f7-4d0a-aab3-84aa49ca8ee8", "Errors": [{"NextAction": "d07410f9-48f7-4d0a-aab3-84aa49ca8ee8", "ErrorType": "NoMatchingError"}]}}, {"Parameters": {}, "Identifier": "d07410f9-48f7-4d0a-aab3-84aa49ca8ee8", "Type": "DisconnectParticipant", "Transitions": {}}]}
        - iLambdaLambdafunction: !GetAtt rLambdaConnectGetFlowData.Arn
          iConnectContactflowCloudInteractCorePreQueue: !GetAtt rConnectContactFlowCloudInteractCorePreQueue.ContactFlowArn
          iConnectContactFlowModuleCloudInteractCorePlayPrompt: !GetAtt rConnectContactFlowModuleCloudInteractCorePlayPrompt.ContactFlowModuleArn

  rConnectContactFlowCloudInteractCoreWhisperAgent:
    Type: AWS::Connect::ContactFlow
    Properties:
      Description: Agent Whisper Flow
      Name: CloudInteract_Core_WhisperAgent
      State: ACTIVE
      Type: AGENT_WHISPER
      InstanceArn: !Ref pConnectInstanceArn
      Content: |
        {"Version": "2019-10-30", "StartAction": "17107c2e-3788-453e-b0aa-0baba554bafd", "Metadata": {"entryPointPosition": {"x": 91.2, "y": 740.8}, "ActionMetadata": {"00b3f5c5-3a0d-4fb6-af68-a84380747612": {"position": {"x": 524.8, "y": 1180.8}, "parameters": {"SSML": {"useDynamic": true}}, "useDynamic": true}, "24fdc9d0-2a5b-4887-8ee7-b31de48dacb9": {"position": {"x": 495.2, "y": 1388.8}, "parameters": {"Text": {"useDynamic": true}}, "useDynamic": true}, "9f94f005-9168-428f-b499-1f9aeaf54260": {"position": {"x": 553.6, "y": 923.2}}, "6ae4cc39-c67d-4572-b7b2-ca290317ff0b": {"position": {"x": 548, "y": 744.8}, "parameters": {"PromptId": {"useDynamic": true}}, "useDynamic": true}, "45136a3a-007c-47dd-bf9f-b3418b9fa4d9": {"position": {"x": 961.6, "y": 922.4}}, "17107c2e-3788-453e-b0aa-0baba554bafd": {"position": {"x": 256, "y": 729.6}, "conditions": [], "conditionMetadata": [{"id": "cfea4b21-7069-43ab-b196-94ff82cbb6c7", "operator": {"name": "Equals", "value": "Equals", "shortDisplay": "="}, "value": "$.Attributes.Null"}, {"id": "37ae32f2-1dc0-4861-9068-e53317e11762", "operator": {"name": "Starts with", "value": "StartsWith", "shortDisplay": "starts with"}, "value": "arn"}, {"id": "22e81758-5dd7-407c-8186-6bddcb06bc53", "operator": {"name": "Starts with", "value": "StartsWith", "shortDisplay": "starts with"}, "value": "http"}, {"id": "917661e2-dd0f-46f9-b653-aa638aafb88f", "operator": {"name": "Starts with", "value": "StartsWith", "shortDisplay": "starts with"}, "value": "<speak>"}]}, "a0e1a9dc-d93b-4b91-b935-7a53c9402f4d": {"position": {"x": 534.4, "y": 562.4}}}, "Annotations": []}, "Actions": [{"Parameters": {"SSML": "$.Attributes.Prompt_Queue_WhisperAgent"}, "Identifier": "00b3f5c5-3a0d-4fb6-af68-a84380747612", "Type": "MessageParticipant", "Transitions": {"NextAction": "45136a3a-007c-47dd-bf9f-b3418b9fa4d9"}}, {"Parameters": {"Text": "$.Attributes.Prompt_Queue_WhisperAgent"}, "Identifier": "24fdc9d0-2a5b-4887-8ee7-b31de48dacb9", "Type": "MessageParticipant", "Transitions": {"NextAction": "45136a3a-007c-47dd-bf9f-b3418b9fa4d9"}}, {"Parameters": {"FlowAttributes": {"Log_ERROR": {"Value": "S3 Prompts not supported in Customer Whisper Flows"}}}, "Identifier": "9f94f005-9168-428f-b499-1f9aeaf54260", "Type": "UpdateFlowAttributes", "Transitions": {"NextAction": "45136a3a-007c-47dd-bf9f-b3418b9fa4d9", "Errors": [{"NextAction": "45136a3a-007c-47dd-bf9f-b3418b9fa4d9", "ErrorType": "NoMatchingError"}]}}, {"Parameters": {"PromptId": "$.Attributes.Prompt_Queue_WhisperAgent"}, "Identifier": "6ae4cc39-c67d-4572-b7b2-ca290317ff0b", "Type": "MessageParticipant", "Transitions": {"NextAction": "45136a3a-007c-47dd-bf9f-b3418b9fa4d9"}}, {"Parameters": {}, "Identifier": "45136a3a-007c-47dd-bf9f-b3418b9fa4d9", "Type": "EndFlowExecution", "Transitions": {}}, {"Parameters": {"ComparisonValue": "$.Attributes.Prompt_Queue_WhisperAgent"}, "Identifier": "17107c2e-3788-453e-b0aa-0baba554bafd", "Type": "Compare", "Transitions": {"NextAction": "24fdc9d0-2a5b-4887-8ee7-b31de48dacb9", "Conditions": [{"NextAction": "a0e1a9dc-d93b-4b91-b935-7a53c9402f4d", "Condition": {"Operator": "Equals", "Operands": ["$.Attributes.Null"]}}, {"NextAction": "6ae4cc39-c67d-4572-b7b2-ca290317ff0b", "Condition": {"Operator": "TextStartsWith", "Operands": ["arn"]}}, {"NextAction": "9f94f005-9168-428f-b499-1f9aeaf54260", "Condition": {"Operator": "TextStartsWith", "Operands": ["http"]}}, {"NextAction": "00b3f5c5-3a0d-4fb6-af68-a84380747612", "Condition": {"Operator": "TextStartsWith", "Operands": ["<speak>"]}}], "Errors": [{"NextAction": "24fdc9d0-2a5b-4887-8ee7-b31de48dacb9", "ErrorType": "NoMatchingCondition"}]}}, {"Parameters": {"FlowAttributes": {"Log_WARN": {"Value": "Prompt_Queue_WhisperCustomer was empty, returning to flow"}}}, "Identifier": "a0e1a9dc-d93b-4b91-b935-7a53c9402f4d", "Type": "UpdateFlowAttributes", "Transitions": {"NextAction": "45136a3a-007c-47dd-bf9f-b3418b9fa4d9", "Errors": [{"NextAction": "45136a3a-007c-47dd-bf9f-b3418b9fa4d9", "ErrorType": "NoMatchingError"}]}}]}


####
# Connect Resources - Hours of Operation
####
## Amazon Connect Queues ##
  rConnectHoursOfOperationSampleDepartmentRetailAlwaysOpen:
    Type: AWS::Connect::HoursOfOperation
    Properties: 
      Config: 
        - Day: MONDAY
          EndTime: 
            Hours: 0
            Minutes: 0
          StartTime: 
            Hours: 0
            Minutes: 0
        - Day: TUESDAY
          EndTime: 
            Hours: 0
            Minutes: 0
          StartTime: 
            Hours: 0
            Minutes: 0
        - Day: WEDNESDAY
          EndTime: 
            Hours: 0
            Minutes: 0
          StartTime: 
            Hours: 0
            Minutes: 0
        - Day: THURSDAY
          EndTime: 
            Hours: 0
            Minutes: 0
          StartTime: 
            Hours: 0
            Minutes: 0
        - Day: FRIDAY
          EndTime: 
            Hours: 0
            Minutes: 0
          StartTime: 
            Hours: 0
            Minutes: 0
        - Day: SATURDAY
          EndTime: 
            Hours: 0
            Minutes: 0
          StartTime: 
            Hours: 0
            Minutes: 0
        - Day: SUNDAY
          EndTime: 
            Hours: 0
            Minutes: 0
          StartTime: 
            Hours: 0
            Minutes: 0
      Description: Always Open Hours of Operation
      InstanceArn: !Ref pConnectInstanceArn
      Name: SampleDepartment_Retail_AlwaysOpen
      TimeZone: Europe/London

####
# Connect Resources - Queues
####

  rConnectQueueSampleDepartmentDefault:
    Type: AWS::Connect::Queue
    Properties: 
      Description: Sample Department - Default Queue
      HoursOfOperationArn: !Ref rConnectHoursOfOperationSampleDepartmentRetailAlwaysOpen
      InstanceArn: !Ref pConnectInstanceArn
      Name: SampleDepartment_Default
      Status: ENABLED

  rConnectQueueSampleDepartmentRetailOther:
    Type: AWS::Connect::Queue
    Properties: 
      Description: Sample Department - Retail - Other
      HoursOfOperationArn: !Ref rConnectHoursOfOperationSampleDepartmentRetailAlwaysOpen
      InstanceArn: !Ref pConnectInstanceArn
      Name: SampleDepartment_Retail_Default
      Status: ENABLED

  rConnectQueueSampleDepartmentRetailNewProductOnline:
    Type: AWS::Connect::Queue
    Properties: 
      Description: Sample Department - Retail - New Product - Online
      HoursOfOperationArn: !Ref rConnectHoursOfOperationSampleDepartmentRetailAlwaysOpen
      InstanceArn: !Ref pConnectInstanceArn
      Name: SampleDepartment_Retail_NewProduct_Online
      Status: ENABLED

  rConnectQueueSampleDepartmentRetailNewProductInStore:
    Type: AWS::Connect::Queue
    Properties: 
      Description: Sample Department - Retail - New Product - In-Store
      HoursOfOperationArn: !Ref rConnectHoursOfOperationSampleDepartmentRetailAlwaysOpen
      InstanceArn: !Ref pConnectInstanceArn
      Name: SampleDepartment_Retail_NewProduct_InStore
      Status: ENABLED

  rConnectQueueSampleDepartmentRetailNewProductOther:
    Type: AWS::Connect::Queue
    Properties: 
      Description: Sample Department - Retail - New Product - Other
      HoursOfOperationArn: !Ref rConnectHoursOfOperationSampleDepartmentRetailAlwaysOpen
      InstanceArn: !Ref pConnectInstanceArn
      Name: SampleDepartment_Retail_NewProduct_Other
      Status: ENABLED


  rConnectQueueSampleDepartmentRetailExistingProduct:
    Type: AWS::Connect::Queue
    Properties: 
      Description: Sample Department - Retail - Existing Product
      HoursOfOperationArn: !Ref rConnectHoursOfOperationSampleDepartmentRetailAlwaysOpen
      InstanceArn: !Ref pConnectInstanceArn
      Name: SampleDepartment_Retail_ExistingProduct
      Status: ENABLED

####
# Connect Resources - Phone Number
####

  rConnectPhoneNumberSampleCustomer:
    Type: AWS::Connect::PhoneNumber
    Properties:
      CountryCode: GB
      Description: Sample Department - Retail
      Prefix: "+44"
      TargetArn: !Ref pConnectInstanceArn
      Type: DID

####
# Outputs
####
Outputs:
  oDynamoDbTableConnectFlowDataName:
    Description: DyanmoDb Table name to store Flow Config
    Value:
      Ref: rDynamoDbTableConnectFlowData
    Export:
      Name: !Sub ${AWS::StackName}-oDynamoDbTableConnectFlowDataName
  oLambdaConnectGetFlowDataArn:
    Description: Lambda ARN to get Flow Config from DynamoDb
    Value: !GetAtt rLambdaConnectGetFlowData.Arn
    Export:
      Name: !Sub ${AWS::StackName}-oLambdaConnectGetFlowDataArn
